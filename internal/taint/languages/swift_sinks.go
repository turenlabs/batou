package languages

import (
	"github.com/turenio/gtss/internal/rules"
	"github.com/turenio/gtss/internal/taint"
)

func (c *SwiftCatalog) Sinks() []taint.SinkDef {
	return []taint.SinkDef{
		// --- File Operations (CWE-22) ---
		{
			ID:            "swift.filemanager.createfile",
			Category:      taint.SnkFileWrite,
			Language:      rules.LangSwift,
			Pattern:       `FileManager\.default\.createFile\(|\.createFile\(\s*atPath:`,
			ObjectType:    "FileManager",
			MethodName:    "createFile(atPath:)",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "File creation with potentially tainted path",
			CWEID:         "CWE-22",
			OWASPCategory: "A01:2021-Broken Access Control",
		},
		{
			ID:            "swift.filemanager.contents",
			Category:      taint.SnkFileWrite,
			Language:      rules.LangSwift,
			Pattern:       `FileManager\.default\.contents\(\s*atPath:|\.contentsOfDirectory\(`,
			ObjectType:    "FileManager",
			MethodName:    "contents(atPath:)",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "File read with potentially tainted path",
			CWEID:         "CWE-22",
			OWASPCategory: "A01:2021-Broken Access Control",
		},
		{
			ID:            "swift.filemanager.movecopy",
			Category:      taint.SnkFileWrite,
			Language:      rules.LangSwift,
			Pattern:       `FileManager\.default\.(?:moveItem|copyItem)\(`,
			ObjectType:    "FileManager",
			MethodName:    "moveItem/copyItem",
			DangerousArgs: []int{0, 1},
			Severity:      rules.High,
			Description:   "File move/copy with potentially tainted path",
			CWEID:         "CWE-22",
			OWASPCategory: "A01:2021-Broken Access Control",
		},
		{
			ID:            "swift.data.write",
			Category:      taint.SnkFileWrite,
			Language:      rules.LangSwift,
			Pattern:       `\.write\(\s*to:\s*URL|\.write\(\s*toFile:`,
			ObjectType:    "Data",
			MethodName:    "write(to:)",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "Data write to potentially tainted file path",
			CWEID:         "CWE-22",
			OWASPCategory: "A01:2021-Broken Access Control",
		},

		// --- Network / SSRF (CWE-918) ---
		{
			ID:            "swift.urlsession.request",
			Category:      taint.SnkURLFetch,
			Language:      rules.LangSwift,
			Pattern:       `URLSession\.shared\.dataTask\(\s*with:|\.dataTask\(\s*with:\s*URLRequest`,
			ObjectType:    "URLSession",
			MethodName:    "dataTask(with:)",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "URL request with potentially tainted URL (SSRF)",
			CWEID:         "CWE-918",
			OWASPCategory: "A10:2021-Server-Side Request Forgery",
		},

		// --- Command Execution (CWE-78) ---
		{
			ID:            "swift.process.launch",
			Category:      taint.SnkCommand,
			Language:      rules.LangSwift,
			Pattern:       `Process\(\)|NSTask\(\)`,
			ObjectType:    "Process",
			MethodName:    "Process/NSTask",
			DangerousArgs: []int{-1},
			Severity:      rules.Critical,
			Description:   "OS process/command execution with potentially tainted arguments",
			CWEID:         "CWE-78",
			OWASPCategory: "A03:2021-Injection",
		},
		{
			ID:            "swift.process.arguments",
			Category:      taint.SnkCommand,
			Language:      rules.LangSwift,
			Pattern:       `\.arguments\s*=|\.launchPath\s*=`,
			ObjectType:    "Process",
			MethodName:    "arguments/launchPath",
			DangerousArgs: []int{0},
			Severity:      rules.Critical,
			Description:   "Process arguments set with potentially tainted values",
			CWEID:         "CWE-78",
			OWASPCategory: "A03:2021-Injection",
		},

		// --- WKWebView JavaScript Injection (CWE-79) ---
		{
			ID:            "swift.wkwebview.evaluatejavascript",
			Category:      taint.SnkEval,
			Language:      rules.LangSwift,
			Pattern:       `\.evaluateJavaScript\(`,
			ObjectType:    "WKWebView",
			MethodName:    "evaluateJavaScript",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "WKWebView JavaScript evaluation with potentially tainted script",
			CWEID:         "CWE-79",
			OWASPCategory: "A03:2021-Injection",
		},
		{
			ID:            "swift.wkwebview.loadhtmlstring",
			Category:      taint.SnkHTMLOutput,
			Language:      rules.LangSwift,
			Pattern:       `\.loadHTMLString\(`,
			ObjectType:    "WKWebView",
			MethodName:    "loadHTMLString",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "WKWebView HTML loading with potentially tainted content",
			CWEID:         "CWE-79",
			OWASPCategory: "A03:2021-Injection",
		},

		// --- SQLite Injection (CWE-89) ---
		{
			ID:            "swift.sqlite3.exec",
			Category:      taint.SnkSQLQuery,
			Language:      rules.LangSwift,
			Pattern:       `sqlite3_exec\(`,
			ObjectType:    "",
			MethodName:    "sqlite3_exec",
			DangerousArgs: []int{1},
			Severity:      rules.Critical,
			Description:   "SQLite query execution with potentially tainted SQL string",
			CWEID:         "CWE-89",
			OWASPCategory: "A03:2021-Injection",
		},
		{
			ID:            "swift.sqlite3.prepare",
			Category:      taint.SnkSQLQuery,
			Language:      rules.LangSwift,
			Pattern:       `sqlite3_prepare(?:_v[23])?\(`,
			ObjectType:    "",
			MethodName:    "sqlite3_prepare",
			DangerousArgs: []int{1},
			Severity:      rules.High,
			Description:   "SQLite prepare with potentially tainted SQL string",
			CWEID:         "CWE-89",
			OWASPCategory: "A03:2021-Injection",
		},

		// --- Insecure Storage (CWE-922) ---
		{
			ID:            "swift.userdefaults.set",
			Category:      taint.SnkFileWrite,
			Language:      rules.LangSwift,
			Pattern:       `UserDefaults\.standard\.set\(`,
			ObjectType:    "UserDefaults",
			MethodName:    "set(_:forKey:)",
			DangerousArgs: []int{0},
			Severity:      rules.Medium,
			Description:   "UserDefaults storage (insecure for sensitive data)",
			CWEID:         "CWE-922",
			OWASPCategory: "A04:2021-Insecure Design",
		},

		// --- Keychain with insecure access (CWE-921) ---
		{
			ID:            "swift.keychain.accessible.always",
			Category:      taint.SnkCrypto,
			Language:      rules.LangSwift,
			Pattern:       `kSecAttrAccessibleAlways\b|kSecAttrAccessibleAlwaysThisDeviceOnly\b`,
			ObjectType:    "Security",
			MethodName:    "kSecAttrAccessibleAlways",
			DangerousArgs: []int{-1},
			Severity:      rules.High,
			Description:   "Keychain item accessible when device is locked",
			CWEID:         "CWE-921",
			OWASPCategory: "A04:2021-Insecure Design",
		},

		// --- Logging sensitive data (CWE-532) ---
		{
			ID:            "swift.oslog",
			Category:      taint.SnkLog,
			Language:      rules.LangSwift,
			Pattern:       `os_log\(|Logger\(\)\.(?:info|debug|error|warning|notice|critical|fault)\(`,
			ObjectType:    "",
			MethodName:    "os_log/Logger",
			DangerousArgs: []int{-1},
			Severity:      rules.Medium,
			Description:   "Logging with potentially sensitive tainted data",
			CWEID:         "CWE-532",
			OWASPCategory: "A09:2021-Security Logging and Monitoring Failures",
		},
		{
			ID:            "swift.nslog",
			Category:      taint.SnkLog,
			Language:      rules.LangSwift,
			Pattern:       `NSLog\(`,
			ObjectType:    "",
			MethodName:    "NSLog",
			DangerousArgs: []int{-1},
			Severity:      rules.Medium,
			Description:   "NSLog with potentially sensitive tainted data",
			CWEID:         "CWE-532",
			OWASPCategory: "A09:2021-Security Logging and Monitoring Failures",
		},
		{
			ID:            "swift.print.sensitive",
			Category:      taint.SnkLog,
			Language:      rules.LangSwift,
			Pattern:       `print\(`,
			ObjectType:    "",
			MethodName:    "print",
			DangerousArgs: []int{0},
			Severity:      rules.Low,
			Description:   "Print statement with potentially sensitive data",
			CWEID:         "CWE-532",
			OWASPCategory: "A09:2021-Security Logging and Monitoring Failures",
		},

		// --- Pasteboard write (CWE-200) ---
		{
			ID:            "swift.pasteboard.write",
			Category:      taint.SnkHTMLOutput,
			Language:      rules.LangSwift,
			Pattern:       `UIPasteboard\.general\.string\s*=|UIPasteboard\.general\.setValue\(`,
			ObjectType:    "UIPasteboard",
			MethodName:    "string= / setValue",
			DangerousArgs: []int{0},
			Severity:      rules.Medium,
			Description:   "Sensitive data written to system pasteboard",
			CWEID:         "CWE-200",
			OWASPCategory: "A01:2021-Broken Access Control",
		},

		// --- Vapor response (CWE-79) ---
		{
			ID:            "swift.vapor.response.body",
			Category:      taint.SnkHTMLOutput,
			Language:      rules.LangSwift,
			Pattern:       `Response\(\s*status:.*body:|\.encodeResponse\(`,
			ObjectType:    "Response",
			MethodName:    "Response(body:)",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "Vapor HTTP response with potentially tainted data",
			CWEID:         "CWE-79",
			OWASPCategory: "A03:2021-Injection",
		},

		// --- Template Injection (CWE-1336) ---
		{
			ID:            "swift.leaf.render",
			Category:      taint.SnkTemplate,
			Language:      rules.LangSwift,
			Pattern:       `req\.view\.render\s*\(|app\.view\.render\s*\(`,
			ObjectType:    "ViewRenderer",
			MethodName:    "view.render",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "Vapor Leaf template rendering with potentially tainted data",
			CWEID:         "CWE-1336",
			OWASPCategory: "A03:2021-Injection",
		},
		{
			ID:            "swift.stencil.render",
			Category:      taint.SnkTemplate,
			Language:      rules.LangSwift,
			Pattern:       `Environment\(\)\.renderTemplate\s*\(|Template\(.*\)\.render\s*\(`,
			ObjectType:    "Stencil",
			MethodName:    "renderTemplate/render",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "Stencil template rendering with potentially tainted context",
			CWEID:         "CWE-1336",
			OWASPCategory: "A03:2021-Injection",
		},

		// --- GRDB / FMDB SQL (CWE-89) ---
		{
			ID:            "swift.grdb.execute",
			Category:      taint.SnkSQLQuery,
			Language:      rules.LangSwift,
			Pattern:       `db\.execute\(\s*sql:|\.execute\(\s*sql:`,
			ObjectType:    "GRDB",
			MethodName:    "execute(sql:)",
			DangerousArgs: []int{0},
			Severity:      rules.Critical,
			Description:   "GRDB SQL execution with potentially tainted query",
			CWEID:         "CWE-89",
			OWASPCategory: "A03:2021-Injection",
		},
		{
			ID:            "swift.fmdb.executequery",
			Category:      taint.SnkSQLQuery,
			Language:      rules.LangSwift,
			Pattern:       `\.executeQuery\s*\(|\.executeUpdate\s*\(`,
			ObjectType:    "FMDatabase",
			MethodName:    "executeQuery/executeUpdate",
			DangerousArgs: []int{0},
			Severity:      rules.Critical,
			Description:   "FMDB SQL execution with potentially tainted query",
			CWEID:         "CWE-89",
			OWASPCategory: "A03:2021-Injection",
		},

		// --- Weak Crypto (CWE-328) ---
		{
			ID:            "swift.crypto.cc_md5",
			Category:      taint.SnkCrypto,
			Language:      rules.LangSwift,
			Pattern:       `CC_MD5\s*\(|Insecure\.MD5`,
			ObjectType:    "",
			MethodName:    "CC_MD5/Insecure.MD5",
			DangerousArgs: []int{0},
			Severity:      rules.Medium,
			Description:   "Weak MD5 hash algorithm usage",
			CWEID:         "CWE-328",
			OWASPCategory: "A02:2021-Cryptographic Failures",
		},
		{
			ID:            "swift.crypto.cc_sha1",
			Category:      taint.SnkCrypto,
			Language:      rules.LangSwift,
			Pattern:       `CC_SHA1\s*\(|Insecure\.SHA1`,
			ObjectType:    "",
			MethodName:    "CC_SHA1/Insecure.SHA1",
			DangerousArgs: []int{0},
			Severity:      rules.Medium,
			Description:   "Weak SHA1 hash algorithm usage",
			CWEID:         "CWE-328",
			OWASPCategory: "A02:2021-Cryptographic Failures",
		},

		// --- HTTP Header Injection (CWE-113) ---
		{
			ID:            "swift.httpheader.set",
			Category:      taint.SnkHeader,
			Language:      rules.LangSwift,
			Pattern:       `\.setValue\(\s*.*forHTTPHeaderField:|\.addValue\(\s*.*forHTTPHeaderField:`,
			ObjectType:    "URLRequest",
			MethodName:    "setValue(forHTTPHeaderField:)",
			DangerousArgs: []int{0},
			Severity:      rules.Medium,
			Description:   "HTTP header set with potentially tainted value",
			CWEID:         "CWE-113",
			OWASPCategory: "A03:2021-Injection",
		},
		{
			ID:            "swift.vapor.response.headers",
			Category:      taint.SnkHeader,
			Language:      rules.LangSwift,
			Pattern:       `res\.headers\.add\(|res\.headers\.replaceOrAdd\(`,
			ObjectType:    "Response",
			MethodName:    "res.headers.add",
			DangerousArgs: []int{0},
			Severity:      rules.Medium,
			Description:   "Vapor response header with potentially tainted value",
			CWEID:         "CWE-113",
			OWASPCategory: "A03:2021-Injection",
		},

		// --- Open Redirect (CWE-601) ---
		{
			ID:            "swift.vapor.redirect",
			Category:      taint.SnkRedirect,
			Language:      rules.LangSwift,
			Pattern:       `req\.redirect\(\s*to:|\.redirect\(\s*to:`,
			ObjectType:    "Request",
			MethodName:    "redirect(to:)",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "Vapor redirect with potentially tainted URL",
			CWEID:         "CWE-601",
			OWASPCategory: "A01:2021-Broken Access Control",
		},

		// --- Deserialization (CWE-502) ---
		{
			ID:            "swift.nskeyedunarchiver",
			Category:      taint.SnkDeserialize,
			Language:      rules.LangSwift,
			Pattern:       `NSKeyedUnarchiver\.unarchiveObject\(|NSKeyedUnarchiver\.unarchivedObject\(`,
			ObjectType:    "NSKeyedUnarchiver",
			MethodName:    "unarchiveObject",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "NSKeyedUnarchiver deserialization of potentially untrusted data",
			CWEID:         "CWE-502",
			OWASPCategory: "A08:2021-Software and Data Integrity Failures",
		},

		// --- File operations (CWE-22) ---
		{
			ID:            "swift.filemanager.copyitem",
			Category:      taint.SnkFileWrite,
			Language:      rules.LangSwift,
			Pattern:       `FileManager\.default\.copyItem\s*\(`,
			ObjectType:    "FileManager",
			MethodName:    "copyItem",
			DangerousArgs: []int{0, 1},
			Severity:      rules.High,
			Description:   "File copy with potentially tainted paths",
			CWEID:         "CWE-22",
			OWASPCategory: "A01:2021-Broken Access Control",
		},
		{
			ID:            "swift.filemanager.moveitem",
			Category:      taint.SnkFileWrite,
			Language:      rules.LangSwift,
			Pattern:       `FileManager\.default\.moveItem\s*\(`,
			ObjectType:    "FileManager",
			MethodName:    "moveItem",
			DangerousArgs: []int{0, 1},
			Severity:      rules.High,
			Description:   "File move with potentially tainted paths",
			CWEID:         "CWE-22",
			OWASPCategory: "A01:2021-Broken Access Control",
		},
		{
			ID:            "swift.filemanager.createsymboliclink",
			Category:      taint.SnkFileWrite,
			Language:      rules.LangSwift,
			Pattern:       `FileManager\.default\.createSymbolicLink\s*\(`,
			ObjectType:    "FileManager",
			MethodName:    "createSymbolicLink",
			DangerousArgs: []int{0, 1},
			Severity:      rules.High,
			Description:   "Symlink creation with potentially tainted paths",
			CWEID:         "CWE-59",
			OWASPCategory: "A01:2021-Broken Access Control",
		},

		// --- ReDoS (CWE-1333) ---
		{
			ID:            "swift.nsregularexpression",
			Category:      taint.SnkEval,
			Language:      rules.LangSwift,
			Pattern:       `NSRegularExpression\s*\(|try\s+NSRegularExpression\s*\(`,
			ObjectType:    "NSRegularExpression",
			MethodName:    "NSRegularExpression",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "Regex construction with potentially tainted pattern (ReDoS risk)",
			CWEID:         "CWE-1333",
			OWASPCategory: "A03:2021-Injection",
		},

		// --- iOS deep link redirect ---
		{
			ID:            "swift.uiapplication.open",
			Category:      taint.SnkRedirect,
			Language:      rules.LangSwift,
			Pattern:       `UIApplication\.shared\.open\s*\(`,
			ObjectType:    "UIApplication",
			MethodName:    "open",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "iOS URL open with potentially tainted URL (deep link redirect)",
			CWEID:         "CWE-601",
			OWASPCategory: "A01:2021-Broken Access Control",
		},
	}
}
