package languages

import (
	"github.com/turenio/gtss/internal/rules"
	"github.com/turenio/gtss/internal/taint"
)

func (c *CSharpCatalog) Sinks() []taint.SinkDef {
	return append(csharpCoreSinks(), csharpCryptoSinks()...)
}

func csharpCoreSinks() []taint.SinkDef {
	return []taint.SinkDef{
		// --- SQL Injection (CWE-89) ---
		{
			ID:            "csharp.ef.fromsqlraw",
			Category:      taint.SnkSQLQuery,
			Language:      rules.LangCSharp,
			Pattern:       `\.FromSqlRaw\(`,
			ObjectType:    "DbSet",
			MethodName:    "FromSqlRaw",
			DangerousArgs: []int{0},
			Severity:      rules.Critical,
			Description:   "Entity Framework raw SQL query with potentially tainted input",
			CWEID:         "CWE-89",
			OWASPCategory: "A03:2021-Injection",
		},
		{
			ID:            "csharp.ef.executesqlraw",
			Category:      taint.SnkSQLQuery,
			Language:      rules.LangCSharp,
			Pattern:       `\.ExecuteSqlRaw\(`,
			ObjectType:    "DatabaseFacade",
			MethodName:    "ExecuteSqlRaw",
			DangerousArgs: []int{0},
			Severity:      rules.Critical,
			Description:   "Entity Framework raw SQL execution with potentially tainted input",
			CWEID:         "CWE-89",
			OWASPCategory: "A03:2021-Injection",
		},
		{
			ID:            "csharp.sqlcommand.text",
			Category:      taint.SnkSQLQuery,
			Language:      rules.LangCSharp,
			Pattern:       `new\s+SqlCommand\s*\(|\.CommandText\s*=`,
			ObjectType:    "SqlCommand",
			MethodName:    "SqlCommand/CommandText",
			DangerousArgs: []int{0},
			Severity:      rules.Critical,
			Description:   "SQL command with potentially tainted query string",
			CWEID:         "CWE-89",
			OWASPCategory: "A03:2021-Injection",
		},
		{
			ID:            "csharp.sqlcommand.executenonquery",
			Category:      taint.SnkSQLQuery,
			Language:      rules.LangCSharp,
			Pattern:       `\.ExecuteNonQuery\(|\.ExecuteScalar\(|\.ExecuteReader\(`,
			ObjectType:    "SqlCommand",
			MethodName:    "ExecuteNonQuery/ExecuteScalar/ExecuteReader",
			DangerousArgs: []int{-1},
			Severity:      rules.High,
			Description:   "SQL command execution (dangerous if CommandText is tainted)",
			CWEID:         "CWE-89",
			OWASPCategory: "A03:2021-Injection",
		},
		{
			ID:            "csharp.dapper.query",
			Category:      taint.SnkSQLQuery,
			Language:      rules.LangCSharp,
			Pattern:       `\.Query\(|\.QueryAsync\(|\.QueryFirst\(|\.QuerySingle\(|\.Execute\(|\.ExecuteAsync\(`,
			ObjectType:    "IDbConnection (Dapper)",
			MethodName:    "Query/Execute",
			DangerousArgs: []int{0},
			Severity:      rules.Critical,
			Description:   "Dapper query with potentially tainted SQL string",
			CWEID:         "CWE-89",
			OWASPCategory: "A03:2021-Injection",
		},

		// --- Command Injection (CWE-78) ---
		{
			ID:            "csharp.process.start",
			Category:      taint.SnkCommand,
			Language:      rules.LangCSharp,
			Pattern:       `Process\.Start\(`,
			ObjectType:    "System.Diagnostics.Process",
			MethodName:    "Process.Start",
			DangerousArgs: []int{0, 1},
			Severity:      rules.Critical,
			Description:   "OS process execution with potentially tainted arguments",
			CWEID:         "CWE-78",
			OWASPCategory: "A03:2021-Injection",
		},
		{
			ID:            "csharp.process.startinfo",
			Category:      taint.SnkCommand,
			Language:      rules.LangCSharp,
			Pattern:       `ProcessStartInfo\s*\(|\.FileName\s*=|\.Arguments\s*=`,
			ObjectType:    "ProcessStartInfo",
			MethodName:    "ProcessStartInfo",
			DangerousArgs: []int{0},
			Severity:      rules.Critical,
			Description:   "Process start info with potentially tainted command/arguments",
			CWEID:         "CWE-78",
			OWASPCategory: "A03:2021-Injection",
		},

		// --- XSS / HTML Output (CWE-79) ---
		{
			ID:            "csharp.response.write",
			Category:      taint.SnkHTMLOutput,
			Language:      rules.LangCSharp,
			Pattern:       `Response\.Write\(`,
			ObjectType:    "HttpResponse",
			MethodName:    "Response.Write",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "Direct HTTP response write with potentially tainted data (XSS)",
			CWEID:         "CWE-79",
			OWASPCategory: "A03:2021-Injection",
		},
		{
			ID:            "csharp.response.writeasync",
			Category:      taint.SnkHTMLOutput,
			Language:      rules.LangCSharp,
			Pattern:       `Response\.WriteAsync\(`,
			ObjectType:    "HttpResponse",
			MethodName:    "Response.WriteAsync",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "Async HTTP response write with potentially tainted data (XSS)",
			CWEID:         "CWE-79",
			OWASPCategory: "A03:2021-Injection",
		},
		{
			ID:            "csharp.htmlraw",
			Category:      taint.SnkHTMLOutput,
			Language:      rules.LangCSharp,
			Pattern:       `Html\.Raw\(`,
			ObjectType:    "IHtmlHelper",
			MethodName:    "Html.Raw",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "Unescaped HTML output in Razor view with potentially tainted data",
			CWEID:         "CWE-79",
			OWASPCategory: "A03:2021-Injection",
		},
		{
			ID:            "csharp.content.result",
			Category:      taint.SnkHTMLOutput,
			Language:      rules.LangCSharp,
			Pattern:       `new\s+ContentResult\s*\{|Content\s*\(.*"text/html"`,
			ObjectType:    "ContentResult",
			MethodName:    "ContentResult",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "Content result with HTML content type and potentially tainted data",
			CWEID:         "CWE-79",
			OWASPCategory: "A03:2021-Injection",
		},

		// --- Open Redirect (CWE-601) ---
		{
			ID:            "csharp.response.redirect",
			Category:      taint.SnkRedirect,
			Language:      rules.LangCSharp,
			Pattern:       `Response\.Redirect\(|Redirect\(|RedirectPermanent\(`,
			ObjectType:    "HttpResponse/Controller",
			MethodName:    "Redirect",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "HTTP redirect with potentially tainted URL",
			CWEID:         "CWE-601",
			OWASPCategory: "A01:2021-Broken Access Control",
		},

		// --- Path Traversal / File Operations (CWE-22) ---
		{
			ID:            "csharp.file.readalltext",
			Category:      taint.SnkFileWrite,
			Language:      rules.LangCSharp,
			Pattern:       `File\.ReadAllText\(|File\.ReadAllBytes\(|File\.ReadAllLines\(|File\.ReadAllTextAsync\(`,
			ObjectType:    "System.IO.File",
			MethodName:    "File.ReadAll*",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "File read with potentially tainted path",
			CWEID:         "CWE-22",
			OWASPCategory: "A01:2021-Broken Access Control",
		},
		{
			ID:            "csharp.file.writealltext",
			Category:      taint.SnkFileWrite,
			Language:      rules.LangCSharp,
			Pattern:       `File\.WriteAllText\(|File\.WriteAllBytes\(|File\.WriteAllLines\(`,
			ObjectType:    "System.IO.File",
			MethodName:    "File.WriteAll*",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "File write with potentially tainted path",
			CWEID:         "CWE-22",
			OWASPCategory: "A01:2021-Broken Access Control",
		},
		{
			ID:            "csharp.file.delete",
			Category:      taint.SnkFileWrite,
			Language:      rules.LangCSharp,
			Pattern:       `File\.Delete\(`,
			ObjectType:    "System.IO.File",
			MethodName:    "File.Delete",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "File deletion with potentially tainted path",
			CWEID:         "CWE-22",
			OWASPCategory: "A01:2021-Broken Access Control",
		},
		{
			ID:            "csharp.path.combine",
			Category:      taint.SnkFileWrite,
			Language:      rules.LangCSharp,
			Pattern:       `Path\.Combine\(`,
			ObjectType:    "System.IO.Path",
			MethodName:    "Path.Combine",
			DangerousArgs: []int{1},
			Severity:      rules.Medium,
			Description:   "File path construction with potentially tainted component",
			CWEID:         "CWE-22",
			OWASPCategory: "A01:2021-Broken Access Control",
		},
		{
			ID:            "csharp.filestream.new",
			Category:      taint.SnkFileWrite,
			Language:      rules.LangCSharp,
			Pattern:       `new\s+FileStream\s*\(|new\s+StreamWriter\s*\(`,
			ObjectType:    "System.IO.FileStream",
			MethodName:    "new FileStream/StreamWriter",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "File stream opened with potentially tainted path",
			CWEID:         "CWE-22",
			OWASPCategory: "A01:2021-Broken Access Control",
		},

		// --- XML External Entity (CWE-611) ---
		{
			ID:            "csharp.xml.loadxml",
			Category:      taint.SnkDeserialize,
			Language:      rules.LangCSharp,
			Pattern:       `XmlDocument.*\.LoadXml\(|\.Load\(`,
			ObjectType:    "XmlDocument",
			MethodName:    "XmlDocument.LoadXml",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "XML document loaded with potentially tainted data (XXE risk)",
			CWEID:         "CWE-611",
			OWASPCategory: "A05:2021-Security Misconfiguration",
		},
		{
			ID:            "csharp.xml.xmlreader",
			Category:      taint.SnkDeserialize,
			Language:      rules.LangCSharp,
			Pattern:       `XmlReader\.Create\(`,
			ObjectType:    "XmlReader",
			MethodName:    "XmlReader.Create",
			DangerousArgs: []int{0},
			Severity:      rules.Medium,
			Description:   "XML reader created from potentially tainted input",
			CWEID:         "CWE-611",
			OWASPCategory: "A05:2021-Security Misconfiguration",
		},

		// --- SSRF (CWE-918) ---
		{
			ID:            "csharp.httpclient.getasync",
			Category:      taint.SnkURLFetch,
			Language:      rules.LangCSharp,
			Pattern:       `HttpClient.*\.GetAsync\(|HttpClient.*\.GetStringAsync\(|HttpClient.*\.PostAsync\(|HttpClient.*\.SendAsync\(`,
			ObjectType:    "HttpClient",
			MethodName:    "GetAsync/PostAsync/SendAsync",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "HTTP request with potentially tainted URL (SSRF)",
			CWEID:         "CWE-918",
			OWASPCategory: "A10:2021-Server-Side Request Forgery",
		},
		{
			ID:            "csharp.webrequest.create",
			Category:      taint.SnkURLFetch,
			Language:      rules.LangCSharp,
			Pattern:       `WebRequest\.Create\(|WebClient.*\.DownloadString\(|WebClient.*\.DownloadData\(`,
			ObjectType:    "WebRequest/WebClient",
			MethodName:    "WebRequest.Create/WebClient.Download*",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "Web request with potentially tainted URL (SSRF)",
			CWEID:         "CWE-918",
			OWASPCategory: "A10:2021-Server-Side Request Forgery",
		},

		// --- LDAP Injection (CWE-90) ---
		{
			ID:            "csharp.ldap.search",
			Category:      taint.SnkLDAP,
			Language:      rules.LangCSharp,
			Pattern:       `DirectorySearcher.*\.Filter\s*=|new\s+DirectorySearcher\s*\(`,
			ObjectType:    "DirectorySearcher",
			MethodName:    "DirectorySearcher.Filter",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "LDAP search with potentially tainted filter",
			CWEID:         "CWE-90",
			OWASPCategory: "A03:2021-Injection",
		},

		// --- Deserialization (CWE-502) ---
		{
			ID:            "csharp.binaryformatter",
			Category:      taint.SnkDeserialize,
			Language:      rules.LangCSharp,
			Pattern:       `BinaryFormatter.*\.Deserialize\(`,
			ObjectType:    "BinaryFormatter",
			MethodName:    "BinaryFormatter.Deserialize",
			DangerousArgs: []int{0},
			Severity:      rules.Critical,
			Description:   "BinaryFormatter deserialization of untrusted data (RCE risk)",
			CWEID:         "CWE-502",
			OWASPCategory: "A08:2021-Software and Data Integrity Failures",
		},
		{
			ID:            "csharp.xmlserializer",
			Category:      taint.SnkDeserialize,
			Language:      rules.LangCSharp,
			Pattern:       `XmlSerializer.*\.Deserialize\(`,
			ObjectType:    "XmlSerializer",
			MethodName:    "XmlSerializer.Deserialize",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "XML deserialization of potentially tainted data",
			CWEID:         "CWE-502",
			OWASPCategory: "A08:2021-Software and Data Integrity Failures",
		},

		// --- Log Injection (CWE-117) ---
		{
			ID:            "csharp.ilogger.log",
			Category:      taint.SnkLog,
			Language:      rules.LangCSharp,
			Pattern:       `_logger\.Log(?:Information|Warning|Error|Critical|Debug)\(|_logger\.Log\(`,
			ObjectType:    "ILogger",
			MethodName:    "ILogger.Log*",
			DangerousArgs: []int{0},
			Severity:      rules.Medium,
			Description:   "Logger output with potentially tainted data (log injection)",
			CWEID:         "CWE-117",
			OWASPCategory: "A09:2021-Security Logging and Monitoring Failures",
		},
		{
			ID:            "csharp.console.writeline",
			Category:      taint.SnkLog,
			Language:      rules.LangCSharp,
			Pattern:       `Console\.WriteLine\(|Console\.Write\(`,
			ObjectType:    "System.Console",
			MethodName:    "Console.Write*",
			DangerousArgs: []int{0},
			Severity:      rules.Medium,
			Description:   "Console output with potentially tainted data",
			CWEID:         "CWE-117",
			OWASPCategory: "A09:2021-Security Logging and Monitoring Failures",
		},

		// --- Regex DoS (CWE-1333) ---
		{
			ID:            "csharp.regex.new",
			Category:      taint.SnkEval,
			Language:      rules.LangCSharp,
			Pattern:       `new\s+Regex\s*\(`,
			ObjectType:    "System.Text.RegularExpressions.Regex",
			MethodName:    "new Regex",
			DangerousArgs: []int{0},
			Severity:      rules.Medium,
			Description:   "Regex constructed with potentially tainted pattern (ReDoS risk)",
			CWEID:         "CWE-1333",
			OWASPCategory: "A03:2021-Injection",
		},

		// --- Template Injection (CWE-1336) ---
		{
			ID:            "csharp.razorengine.compile",
			Category:      taint.SnkTemplate,
			Language:      rules.LangCSharp,
			Pattern:       `Engine\.Razor\.RunCompile\s*\(|RazorEngine.*\.RunCompile\s*\(|Razor\.Compile\s*\(`,
			ObjectType:    "RazorEngine",
			MethodName:    "Engine.Razor.RunCompile",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "RazorEngine template compilation with potentially tainted template string",
			CWEID:         "CWE-1336",
			OWASPCategory: "A03:2021-Injection",
		},
		{
			ID:            "csharp.scriban.render",
			Category:      taint.SnkTemplate,
			Language:      rules.LangCSharp,
			Pattern:       `Template\.Parse\s*\(.*\.Render\s*\(|Scriban.*\.Render\s*\(`,
			ObjectType:    "Scriban",
			MethodName:    "Template.Parse.Render",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "Scriban template rendering with potentially tainted template",
			CWEID:         "CWE-1336",
			OWASPCategory: "A03:2021-Injection",
		},

		// --- XPath Injection (CWE-643) ---
		{
			ID:            "csharp.xpath.selectnodes",
			Category:      taint.SnkXPath,
			Language:      rules.LangCSharp,
			Pattern:       `\.SelectNodes\s*\(|\.SelectSingleNode\s*\(|XPathExpression\.Compile\s*\(`,
			ObjectType:    "XmlNode",
			MethodName:    "SelectNodes/SelectSingleNode",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "XPath query with potentially tainted expression",
			CWEID:         "CWE-643",
			OWASPCategory: "A03:2021-Injection",
		},

		// --- HTTP Header Injection (CWE-113) ---
		{
			ID:            "csharp.response.headers",
			Category:      taint.SnkHeader,
			Language:      rules.LangCSharp,
			Pattern:       `Response\.Headers\.Add\(|Response\.Headers\.Append\(|Response\.Headers\[`,
			ObjectType:    "HttpResponse",
			MethodName:    "Response.Headers.Add/Append",
			DangerousArgs: []int{1},
			Severity:      rules.Medium,
			Description:   "HTTP response header with potentially tainted value",
			CWEID:         "CWE-113",
			OWASPCategory: "A03:2021-Injection",
		},

		// --- Dynamic LINQ (CWE-89) ---
		{
			ID:            "csharp.dynamiclinq",
			Category:      taint.SnkSQLQuery,
			Language:      rules.LangCSharp,
			Pattern:       `\.Where\s*\(\s*"[^"]*\+|\.OrderBy\s*\(\s*"[^"]*\+`,
			ObjectType:    "Dynamic LINQ",
			MethodName:    "Dynamic LINQ Where/OrderBy",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "Dynamic LINQ with string concatenation (injection risk)",
			CWEID:         "CWE-89",
			OWASPCategory: "A03:2021-Injection",
		},

		// --- File operations (CWE-22) ---
		{
			ID:            "csharp.file.copy",
			Category:      taint.SnkFileWrite,
			Language:      rules.LangCSharp,
			Pattern:       `File\.Copy\s*\(`,
			ObjectType:    "File",
			MethodName:    "Copy",
			DangerousArgs: []int{0, 1},
			Severity:      rules.High,
			Description:   "File copy with potentially tainted paths",
			CWEID:         "CWE-22",
			OWASPCategory: "A01:2021-Broken Access Control",
		},
		{
			ID:            "csharp.file.move",
			Category:      taint.SnkFileWrite,
			Language:      rules.LangCSharp,
			Pattern:       `File\.Move\s*\(`,
			ObjectType:    "File",
			MethodName:    "Move",
			DangerousArgs: []int{0, 1},
			Severity:      rules.High,
			Description:   "File move with potentially tainted paths",
			CWEID:         "CWE-22",
			OWASPCategory: "A01:2021-Broken Access Control",
		},
		{
			ID:            "csharp.directory.createdirectory",
			Category:      taint.SnkFileWrite,
			Language:      rules.LangCSharp,
			Pattern:       `Directory\.CreateDirectory\s*\(`,
			ObjectType:    "Directory",
			MethodName:    "CreateDirectory",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "Directory creation with potentially tainted path",
			CWEID:         "CWE-22",
			OWASPCategory: "A01:2021-Broken Access Control",
		},

		// --- ReDoS ---
		{
			ID:            "csharp.regex.new.tainted",
			Category:      taint.SnkEval,
			Language:      rules.LangCSharp,
			Pattern:       `new\s+Regex\s*\(`,
			ObjectType:    "Regex",
			MethodName:    "Regex (constructor)",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "Regex construction with potentially tainted pattern (ReDoS risk)",
			CWEID:         "CWE-1333",
			OWASPCategory: "A03:2021-Injection",
		},

		// --- SSRF additional ---
		{
			ID:            "csharp.httpclient.postasync",
			Category:      taint.SnkURLFetch,
			Language:      rules.LangCSharp,
			Pattern:       `HttpClient.*\.PostAsync\s*\(|HttpClient.*\.PutAsync\s*\(|HttpClient.*\.SendAsync\s*\(`,
			ObjectType:    "HttpClient",
			MethodName:    "PostAsync/PutAsync/SendAsync",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "HttpClient request with potentially tainted URL (SSRF)",
			CWEID:         "CWE-918",
			OWASPCategory: "A10:2021-Server-Side Request Forgery",
		},

		// --- Cookie injection ---
		{
			ID:            "csharp.response.cookies.append",
			Category:      taint.SnkHeader,
			Language:      rules.LangCSharp,
			Pattern:       `Response\.Cookies\.Append\s*\(`,
			ObjectType:    "HttpResponse",
			MethodName:    "Cookies.Append",
			DangerousArgs: []int{0, 1},
			Severity:      rules.Medium,
			Description:   "Cookie set with potentially tainted value",
			CWEID:         "CWE-113",
			OWASPCategory: "A03:2021-Injection",
		},

		// --- Process start with tainted args ---
		{
			ID:            "csharp.process.start.filename",
			Category:      taint.SnkCommand,
			Language:      rules.LangCSharp,
			Pattern:       `ProcessStartInfo.*FileName\s*=`,
			ObjectType:    "ProcessStartInfo",
			MethodName:    "FileName",
			DangerousArgs: []int{0},
			Severity:      rules.Critical,
			Description:   "Process start with potentially tainted executable path",
			CWEID:         "CWE-78",
			OWASPCategory: "A03:2021-Injection",
		},
	}
}

// csharpCryptoSinks returns sink definitions for detecting weak cryptographic
// algorithm usage in C#. These patterns identify code that should be flagged.
func csharpCryptoSinks() []taint.SinkDef {
	return []taint.SinkDef{
		{
			ID:            "csharp.crypto.md5",
			Category:      taint.SnkCrypto,
			Language:      rules.LangCSharp,
			Pattern:       `MD5\.Create\(|MD5CryptoServiceProvider`,
			ObjectType:    "System.Security.Cryptography",
			MethodName:    "MD5.Create",
			DangerousArgs: []int{-1},
			Severity:      rules.Medium,
			Description:   "MD5 hash usage (weak, vulnerable to collision attacks)",
			CWEID:         "CWE-328",
			OWASPCategory: "A02:2021-Cryptographic Failures",
		},
		{
			ID:            "csharp.crypto.sha1",
			Category:      taint.SnkCrypto,
			Language:      rules.LangCSharp,
			Pattern:       `SHA1\.Create\(|SHA1CryptoServiceProvider|SHA1Managed`,
			ObjectType:    "System.Security.Cryptography",
			MethodName:    "SHA1.Create",
			DangerousArgs: []int{-1},
			Severity:      rules.Medium,
			Description:   "SHA1 hash usage (weak, vulnerable to collision attacks)",
			CWEID:         "CWE-328",
			OWASPCategory: "A02:2021-Cryptographic Failures",
		},
		{
			ID:            "csharp.crypto.weak_symmetric",
			Category:      taint.SnkCrypto,
			Language:      rules.LangCSharp,
			Pattern:       `(?:^|[^a-zA-Z])` + `D` + `E` + `S` + `\.Create\(|` + `D` + `E` + `SCryptoServiceProvider|Triple` + `D` + `E` + `S` + `\.Create\(`,
			ObjectType:    "System.Security.Cryptography",
			MethodName:    "Weak symmetric cipher",
			DangerousArgs: []int{-1},
			Severity:      rules.High,
			Description:   "Weak symmetric cipher usage (use AES instead)",
			CWEID:         "CWE-327",
			OWASPCategory: "A02:2021-Cryptographic Failures",
		},
	}
}
