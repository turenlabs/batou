package languages

import (
	"github.com/turen/gtss/internal/rules"
	"github.com/turen/gtss/internal/taint"
)

func (c *GroovyCatalog) Sinks() []taint.SinkDef {
	return []taint.SinkDef{
		// --- Command Injection (CWE-78) ---
		{
			ID:            "groovy.string.execute",
			Category:      taint.SnkCommand,
			Language:      rules.LangGroovy,
			Pattern:       `\.execute\s*\(`,
			ObjectType:    "String",
			MethodName:    "execute",
			DangerousArgs: []int{-1},
			Severity:      rules.Critical,
			Description:   "Groovy String.execute() runs OS command",
			CWEID:         "CWE-78",
			OWASPCategory: "A03:2021-Injection",
		},
		{
			ID:            "groovy.runtime.exec",
			Category:      taint.SnkCommand,
			Language:      rules.LangGroovy,
			Pattern:       `Runtime\.(?:getRuntime\s*\(\s*\)\s*\.)?exec\s*\(`,
			ObjectType:    "Runtime",
			MethodName:    "exec",
			DangerousArgs: []int{0},
			Severity:      rules.Critical,
			Description:   "OS command execution via Runtime.exec",
			CWEID:         "CWE-78",
			OWASPCategory: "A03:2021-Injection",
		},
		{
			ID:            "groovy.processbuilder",
			Category:      taint.SnkCommand,
			Language:      rules.LangGroovy,
			Pattern:       `new\s+ProcessBuilder\s*\(`,
			ObjectType:    "ProcessBuilder",
			MethodName:    "ProcessBuilder",
			DangerousArgs: []int{-1},
			Severity:      rules.Critical,
			Description:   "OS command execution via ProcessBuilder",
			CWEID:         "CWE-78",
			OWASPCategory: "A03:2021-Injection",
		},

		// --- Code Injection (CWE-94) ---
		{
			ID:            "groovy.groovyshell.evaluate",
			Category:      taint.SnkEval,
			Language:      rules.LangGroovy,
			Pattern:       `GroovyShell\s*\(\s*\)\s*\.evaluate\s*\(|shell\.evaluate\s*\(`,
			ObjectType:    "GroovyShell",
			MethodName:    "evaluate",
			DangerousArgs: []int{0},
			Severity:      rules.Critical,
			Description:   "GroovyShell.evaluate executes arbitrary Groovy code",
			CWEID:         "CWE-94",
			OWASPCategory: "A03:2021-Injection",
		},
		{
			ID:            "groovy.groovyshell.parse",
			Category:      taint.SnkEval,
			Language:      rules.LangGroovy,
			Pattern:       `GroovyShell\s*\(\s*\)\s*\.parse\s*\(|shell\.parse\s*\(`,
			ObjectType:    "GroovyShell",
			MethodName:    "parse",
			DangerousArgs: []int{0},
			Severity:      rules.Critical,
			Description:   "GroovyShell.parse compiles arbitrary Groovy code",
			CWEID:         "CWE-94",
			OWASPCategory: "A03:2021-Injection",
		},
		{
			ID:            "groovy.eval.me",
			Category:      taint.SnkEval,
			Language:      rules.LangGroovy,
			Pattern:       `Eval\.me\s*\(|Eval\.x\s*\(|Eval\.xy\s*\(`,
			ObjectType:    "Eval",
			MethodName:    "me/x/xy",
			DangerousArgs: []int{0},
			Severity:      rules.Critical,
			Description:   "Eval.me executes arbitrary Groovy expressions",
			CWEID:         "CWE-94",
			OWASPCategory: "A03:2021-Injection",
		},
		{
			ID:            "groovy.scriptengine.eval",
			Category:      taint.SnkEval,
			Language:      rules.LangGroovy,
			Pattern:       `GroovyScriptEngine.*\.run\s*\(|ScriptEngine.*\.eval\s*\(`,
			ObjectType:    "GroovyScriptEngine",
			MethodName:    "run/eval",
			DangerousArgs: []int{0},
			Severity:      rules.Critical,
			Description:   "GroovyScriptEngine runs arbitrary scripts",
			CWEID:         "CWE-94",
			OWASPCategory: "A03:2021-Injection",
		},

		// --- SQL Injection (CWE-89) ---
		{
			ID:            "groovy.sql.execute",
			Category:      taint.SnkSQLQuery,
			Language:      rules.LangGroovy,
			Pattern:       `\.execute\s*\(\s*"`,
			ObjectType:    "groovy.sql.Sql",
			MethodName:    "execute",
			DangerousArgs: []int{0},
			Severity:      rules.Critical,
			Description:   "Groovy SQL execute with potential injection",
			CWEID:         "CWE-89",
			OWASPCategory: "A03:2021-Injection",
		},
		{
			ID:            "groovy.sql.rows",
			Category:      taint.SnkSQLQuery,
			Language:      rules.LangGroovy,
			Pattern:       `\.rows\s*\(\s*"`,
			ObjectType:    "groovy.sql.Sql",
			MethodName:    "rows",
			DangerousArgs: []int{0},
			Severity:      rules.Critical,
			Description:   "Groovy SQL rows query with potential injection",
			CWEID:         "CWE-89",
			OWASPCategory: "A03:2021-Injection",
		},
		{
			ID:            "groovy.sql.firstrow",
			Category:      taint.SnkSQLQuery,
			Language:      rules.LangGroovy,
			Pattern:       `\.firstRow\s*\(\s*"`,
			ObjectType:    "groovy.sql.Sql",
			MethodName:    "firstRow",
			DangerousArgs: []int{0},
			Severity:      rules.Critical,
			Description:   "Groovy SQL firstRow query with potential injection",
			CWEID:         "CWE-89",
			OWASPCategory: "A03:2021-Injection",
		},
		{
			ID:            "groovy.sql.executeupdate",
			Category:      taint.SnkSQLQuery,
			Language:      rules.LangGroovy,
			Pattern:       `\.executeUpdate\s*\(\s*"`,
			ObjectType:    "groovy.sql.Sql",
			MethodName:    "executeUpdate",
			DangerousArgs: []int{0},
			Severity:      rules.Critical,
			Description:   "Groovy SQL executeUpdate with potential injection",
			CWEID:         "CWE-89",
			OWASPCategory: "A03:2021-Injection",
		},

		// --- File Operations (CWE-22) ---
		{
			ID:            "groovy.file.new",
			Category:      taint.SnkFileWrite,
			Language:      rules.LangGroovy,
			Pattern:       `new\s+File\s*\(`,
			ObjectType:    "File",
			MethodName:    "File",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "File path with potential traversal",
			CWEID:         "CWE-22",
			OWASPCategory: "A01:2021-Broken Access Control",
		},
		{
			ID:            "groovy.fileoutputstream",
			Category:      taint.SnkFileWrite,
			Language:      rules.LangGroovy,
			Pattern:       `new\s+FileOutputStream\s*\(`,
			ObjectType:    "FileOutputStream",
			MethodName:    "FileOutputStream",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "FileOutputStream with potential path traversal",
			CWEID:         "CWE-22",
			OWASPCategory: "A01:2021-Broken Access Control",
		},

		// --- Redirect (CWE-601) ---
		{
			ID:            "groovy.grails.redirect",
			Category:      taint.SnkRedirect,
			Language:      rules.LangGroovy,
			Pattern:       `redirect\s*\(\s*url\s*:`,
			ObjectType:    "GrailsController",
			MethodName:    "redirect",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "Grails redirect with user-controlled URL",
			CWEID:         "CWE-601",
			OWASPCategory: "A01:2021-Broken Access Control",
		},

		// --- XXE (CWE-611) ---
		{
			ID:            "groovy.xmlslurper.parse",
			Category:      taint.SnkXPath,
			Language:      rules.LangGroovy,
			Pattern:       `new\s+XmlSlurper\s*\(\s*\)\s*\.parse|XmlSlurper\s*\(\s*\)\s*\.parseText`,
			ObjectType:    "XmlSlurper",
			MethodName:    "parse/parseText",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "XmlSlurper parsing without XXE protection",
			CWEID:         "CWE-611",
			OWASPCategory: "A05:2021-Security Misconfiguration",
		},
		{
			ID:            "groovy.xmlparser.parse",
			Category:      taint.SnkXPath,
			Language:      rules.LangGroovy,
			Pattern:       `new\s+XmlParser\s*\(\s*\)\s*\.parse`,
			ObjectType:    "XmlParser",
			MethodName:    "parse/parseText",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "XmlParser parsing without XXE protection",
			CWEID:         "CWE-611",
			OWASPCategory: "A05:2021-Security Misconfiguration",
		},

		// --- Deserialization (CWE-502) ---
		{
			ID:            "groovy.objectinputstream",
			Category:      taint.SnkDeserialize,
			Language:      rules.LangGroovy,
			Pattern:       `ObjectInputStream.*\.readObject\s*\(`,
			ObjectType:    "ObjectInputStream",
			MethodName:    "readObject",
			DangerousArgs: []int{-1},
			Severity:      rules.Critical,
			Description:   "Unsafe Java deserialization in Groovy context",
			CWEID:         "CWE-502",
			OWASPCategory: "A08:2021-Software and Data Integrity Failures",
		},

		// --- HTML Output / XSS (CWE-79) ---
		{
			ID:            "groovy.markupbuilder",
			Category:      taint.SnkHTMLOutput,
			Language:      rules.LangGroovy,
			Pattern:       `new\s+MarkupBuilder\s*\(|MarkupBuilder`,
			ObjectType:    "MarkupBuilder",
			MethodName:    "MarkupBuilder",
			DangerousArgs: []int{-1},
			Severity:      rules.High,
			Description:   "MarkupBuilder with potentially tainted content",
			CWEID:         "CWE-79",
			OWASPCategory: "A03:2021-Injection",
		},

		// --- Log injection (CWE-117) ---
		{
			ID:            "groovy.println",
			Category:      taint.SnkLog,
			Language:      rules.LangGroovy,
			Pattern:       `println\s*\(`,
			ObjectType:    "",
			MethodName:    "println",
			DangerousArgs: []int{0},
			Severity:      rules.Medium,
			Description:   "println with potentially tainted data",
			CWEID:         "CWE-117",
			OWASPCategory: "A09:2021-Security Logging and Monitoring Failures",
		},
	}
}
