package languages

import (
	"github.com/turenio/gtss/internal/rules"
	"github.com/turenio/gtss/internal/taint"
)

func (c *GroovyCatalog) Sinks() []taint.SinkDef {
	return []taint.SinkDef{
		// --- Command Injection (CWE-78) ---
		{
			ID:            "groovy.string.execute",
			Category:      taint.SnkCommand,
			Language:      rules.LangGroovy,
			Pattern:       `\.execute\s*\(`,
			ObjectType:    "String",
			MethodName:    "execute",
			DangerousArgs: []int{-1},
			Severity:      rules.Critical,
			Description:   "Groovy String.execute() runs OS command",
			CWEID:         "CWE-78",
			OWASPCategory: "A03:2021-Injection",
		},
		{
			ID:            "groovy.runtime.exec",
			Category:      taint.SnkCommand,
			Language:      rules.LangGroovy,
			Pattern:       `Runtime\.(?:getRuntime\s*\(\s*\)\s*\.)?exec\s*\(`,
			ObjectType:    "Runtime",
			MethodName:    "exec",
			DangerousArgs: []int{0},
			Severity:      rules.Critical,
			Description:   "OS command execution via Runtime.exec",
			CWEID:         "CWE-78",
			OWASPCategory: "A03:2021-Injection",
		},
		{
			ID:            "groovy.processbuilder",
			Category:      taint.SnkCommand,
			Language:      rules.LangGroovy,
			Pattern:       `new\s+ProcessBuilder\s*\(`,
			ObjectType:    "ProcessBuilder",
			MethodName:    "ProcessBuilder",
			DangerousArgs: []int{-1},
			Severity:      rules.Critical,
			Description:   "OS command execution via ProcessBuilder",
			CWEID:         "CWE-78",
			OWASPCategory: "A03:2021-Injection",
		},

		// --- Code Injection (CWE-94) ---
		{
			ID:            "groovy.groovyshell.evaluate",
			Category:      taint.SnkEval,
			Language:      rules.LangGroovy,
			Pattern:       `GroovyShell\s*\(\s*\)\s*\.evaluate\s*\(|shell\.evaluate\s*\(`,
			ObjectType:    "GroovyShell",
			MethodName:    "evaluate",
			DangerousArgs: []int{0},
			Severity:      rules.Critical,
			Description:   "GroovyShell.evaluate executes arbitrary Groovy code",
			CWEID:         "CWE-94",
			OWASPCategory: "A03:2021-Injection",
		},
		{
			ID:            "groovy.groovyshell.parse",
			Category:      taint.SnkEval,
			Language:      rules.LangGroovy,
			Pattern:       `GroovyShell\s*\(\s*\)\s*\.parse\s*\(|shell\.parse\s*\(`,
			ObjectType:    "GroovyShell",
			MethodName:    "parse",
			DangerousArgs: []int{0},
			Severity:      rules.Critical,
			Description:   "GroovyShell.parse compiles arbitrary Groovy code",
			CWEID:         "CWE-94",
			OWASPCategory: "A03:2021-Injection",
		},
		{
			ID:            "groovy.eval.me",
			Category:      taint.SnkEval,
			Language:      rules.LangGroovy,
			Pattern:       `Eval\.me\s*\(|Eval\.x\s*\(|Eval\.xy\s*\(`,
			ObjectType:    "Eval",
			MethodName:    "me/x/xy",
			DangerousArgs: []int{0},
			Severity:      rules.Critical,
			Description:   "Eval.me executes arbitrary Groovy expressions",
			CWEID:         "CWE-94",
			OWASPCategory: "A03:2021-Injection",
		},
		{
			ID:            "groovy.scriptengine.eval",
			Category:      taint.SnkEval,
			Language:      rules.LangGroovy,
			Pattern:       `GroovyScriptEngine.*\.run\s*\(|ScriptEngine.*\.eval\s*\(`,
			ObjectType:    "GroovyScriptEngine",
			MethodName:    "run/eval",
			DangerousArgs: []int{0},
			Severity:      rules.Critical,
			Description:   "GroovyScriptEngine runs arbitrary scripts",
			CWEID:         "CWE-94",
			OWASPCategory: "A03:2021-Injection",
		},

		// --- SQL Injection (CWE-89) ---
		{
			ID:            "groovy.sql.execute",
			Category:      taint.SnkSQLQuery,
			Language:      rules.LangGroovy,
			Pattern:       `\.execute\s*\(\s*"`,
			ObjectType:    "groovy.sql.Sql",
			MethodName:    "execute",
			DangerousArgs: []int{0},
			Severity:      rules.Critical,
			Description:   "Groovy SQL execute with potential injection",
			CWEID:         "CWE-89",
			OWASPCategory: "A03:2021-Injection",
		},
		{
			ID:            "groovy.sql.rows",
			Category:      taint.SnkSQLQuery,
			Language:      rules.LangGroovy,
			Pattern:       `\.rows\s*\(\s*"`,
			ObjectType:    "groovy.sql.Sql",
			MethodName:    "rows",
			DangerousArgs: []int{0},
			Severity:      rules.Critical,
			Description:   "Groovy SQL rows query with potential injection",
			CWEID:         "CWE-89",
			OWASPCategory: "A03:2021-Injection",
		},
		{
			ID:            "groovy.sql.firstrow",
			Category:      taint.SnkSQLQuery,
			Language:      rules.LangGroovy,
			Pattern:       `\.firstRow\s*\(\s*"`,
			ObjectType:    "groovy.sql.Sql",
			MethodName:    "firstRow",
			DangerousArgs: []int{0},
			Severity:      rules.Critical,
			Description:   "Groovy SQL firstRow query with potential injection",
			CWEID:         "CWE-89",
			OWASPCategory: "A03:2021-Injection",
		},
		{
			ID:            "groovy.sql.executeupdate",
			Category:      taint.SnkSQLQuery,
			Language:      rules.LangGroovy,
			Pattern:       `\.executeUpdate\s*\(\s*"`,
			ObjectType:    "groovy.sql.Sql",
			MethodName:    "executeUpdate",
			DangerousArgs: []int{0},
			Severity:      rules.Critical,
			Description:   "Groovy SQL executeUpdate with potential injection",
			CWEID:         "CWE-89",
			OWASPCategory: "A03:2021-Injection",
		},

		// --- File Operations (CWE-22) ---
		{
			ID:            "groovy.file.new",
			Category:      taint.SnkFileWrite,
			Language:      rules.LangGroovy,
			Pattern:       `new\s+File\s*\(`,
			ObjectType:    "File",
			MethodName:    "File",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "File path with potential traversal",
			CWEID:         "CWE-22",
			OWASPCategory: "A01:2021-Broken Access Control",
		},
		{
			ID:            "groovy.fileoutputstream",
			Category:      taint.SnkFileWrite,
			Language:      rules.LangGroovy,
			Pattern:       `new\s+FileOutputStream\s*\(`,
			ObjectType:    "FileOutputStream",
			MethodName:    "FileOutputStream",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "FileOutputStream with potential path traversal",
			CWEID:         "CWE-22",
			OWASPCategory: "A01:2021-Broken Access Control",
		},

		// --- Redirect (CWE-601) ---
		{
			ID:            "groovy.grails.redirect",
			Category:      taint.SnkRedirect,
			Language:      rules.LangGroovy,
			Pattern:       `redirect\s*\(\s*url\s*:`,
			ObjectType:    "GrailsController",
			MethodName:    "redirect",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "Grails redirect with user-controlled URL",
			CWEID:         "CWE-601",
			OWASPCategory: "A01:2021-Broken Access Control",
		},

		// --- XXE (CWE-611) ---
		{
			ID:            "groovy.xmlslurper.parse",
			Category:      taint.SnkXPath,
			Language:      rules.LangGroovy,
			Pattern:       `new\s+XmlSlurper\s*\(\s*\)\s*\.parse|XmlSlurper\s*\(\s*\)\s*\.parseText`,
			ObjectType:    "XmlSlurper",
			MethodName:    "parse/parseText",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "XmlSlurper parsing without XXE protection",
			CWEID:         "CWE-611",
			OWASPCategory: "A05:2021-Security Misconfiguration",
		},
		{
			ID:            "groovy.xmlparser.parse",
			Category:      taint.SnkXPath,
			Language:      rules.LangGroovy,
			Pattern:       `new\s+XmlParser\s*\(\s*\)\s*\.parse`,
			ObjectType:    "XmlParser",
			MethodName:    "parse/parseText",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "XmlParser parsing without XXE protection",
			CWEID:         "CWE-611",
			OWASPCategory: "A05:2021-Security Misconfiguration",
		},

		// --- Deserialization (CWE-502) ---
		{
			ID:            "groovy.objectinputstream",
			Category:      taint.SnkDeserialize,
			Language:      rules.LangGroovy,
			Pattern:       `ObjectInputStream.*\.readObject\s*\(`,
			ObjectType:    "ObjectInputStream",
			MethodName:    "readObject",
			DangerousArgs: []int{-1},
			Severity:      rules.Critical,
			Description:   "Unsafe Java deserialization in Groovy context",
			CWEID:         "CWE-502",
			OWASPCategory: "A08:2021-Software and Data Integrity Failures",
		},

		// --- HTML Output / XSS (CWE-79) ---
		{
			ID:            "groovy.markupbuilder",
			Category:      taint.SnkHTMLOutput,
			Language:      rules.LangGroovy,
			Pattern:       `new\s+MarkupBuilder\s*\(|MarkupBuilder`,
			ObjectType:    "MarkupBuilder",
			MethodName:    "MarkupBuilder",
			DangerousArgs: []int{-1},
			Severity:      rules.High,
			Description:   "MarkupBuilder with potentially tainted content",
			CWEID:         "CWE-79",
			OWASPCategory: "A03:2021-Injection",
		},

		// --- Log injection (CWE-117) ---
		{
			ID:            "groovy.println",
			Category:      taint.SnkLog,
			Language:      rules.LangGroovy,
			Pattern:       `println\s*\(`,
			ObjectType:    "",
			MethodName:    "println",
			DangerousArgs: []int{0},
			Severity:      rules.Medium,
			Description:   "println with potentially tainted data",
			CWEID:         "CWE-117",
			OWASPCategory: "A09:2021-Security Logging and Monitoring Failures",
		},

		// --- Template Injection (CWE-1336) ---
		{
			ID:            "groovy.gstringtemplate",
			Category:      taint.SnkTemplate,
			Language:      rules.LangGroovy,
			Pattern:       `GStringTemplateEngine\s*\(\s*\)\s*\.createTemplate\s*\(`,
			ObjectType:    "GStringTemplateEngine",
			MethodName:    "createTemplate",
			DangerousArgs: []int{0},
			Severity:      rules.Critical,
			Description:   "GStringTemplateEngine template injection risk",
			CWEID:         "CWE-1336",
			OWASPCategory: "A03:2021-Injection",
		},
		{
			ID:            "groovy.simpletemplateengine",
			Category:      taint.SnkTemplate,
			Language:      rules.LangGroovy,
			Pattern:       `SimpleTemplateEngine\s*\(\s*\)\s*\.createTemplate\s*\(`,
			ObjectType:    "SimpleTemplateEngine",
			MethodName:    "createTemplate",
			DangerousArgs: []int{0},
			Severity:      rules.Critical,
			Description:   "SimpleTemplateEngine template injection risk",
			CWEID:         "CWE-1336",
			OWASPCategory: "A03:2021-Injection",
		},
		{
			ID:            "groovy.grails.render.inline",
			Category:      taint.SnkTemplate,
			Language:      rules.LangGroovy,
			Pattern:       `render\s*\(\s*text\s*:|render\s*\(\s*inline\s*:`,
			ObjectType:    "GrailsController",
			MethodName:    "render(text:/inline:)",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "Grails inline rendering with potentially tainted template",
			CWEID:         "CWE-1336",
			OWASPCategory: "A03:2021-Injection",
		},

		// --- SSRF (CWE-918) ---
		{
			ID:            "groovy.url.get",
			Category:      taint.SnkURLFetch,
			Language:      rules.LangGroovy,
			Pattern:       `new\s+URL\s*\(.*\)\.openConnection\s*\(|\.toURL\s*\(\s*\)\s*\.(?:text|openStream)`,
			ObjectType:    "URL",
			MethodName:    "URL.openConnection",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "URL connection with potentially tainted URL (SSRF)",
			CWEID:         "CWE-918",
			OWASPCategory: "A10:2021-Server-Side Request Forgery",
		},
		{
			ID:            "groovy.httpbuilder",
			Category:      taint.SnkURLFetch,
			Language:      rules.LangGroovy,
			Pattern:       `HTTPBuilder\s*\(|HttpBuilder\.configure\s*\(`,
			ObjectType:    "HTTPBuilder",
			MethodName:    "HTTPBuilder",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "HTTP client with potentially tainted URL (SSRF)",
			CWEID:         "CWE-918",
			OWASPCategory: "A10:2021-Server-Side Request Forgery",
		},

		// --- LDAP Injection (CWE-90) ---
		{
			ID:            "groovy.ldap.search",
			Category:      taint.SnkLDAP,
			Language:      rules.LangGroovy,
			Pattern:       `InitialDirContext.*\.search\s*\(|DirContext.*\.search\s*\(`,
			ObjectType:    "DirContext",
			MethodName:    "DirContext.search",
			DangerousArgs: []int{1},
			Severity:      rules.High,
			Description:   "LDAP search with potentially tainted filter",
			CWEID:         "CWE-90",
			OWASPCategory: "A03:2021-Injection",
		},

		// --- Weak Crypto (CWE-328) ---
		{
			ID:            "groovy.crypto.md5",
			Category:      taint.SnkCrypto,
			Language:      rules.LangGroovy,
			Pattern:       `MessageDigest\.getInstance\s*\(\s*"MD5"|\.md5\s*\(\s*\)|\.encodeAsMD5\s*\(`,
			ObjectType:    "MessageDigest",
			MethodName:    "MD5",
			DangerousArgs: []int{-1},
			Severity:      rules.Medium,
			Description:   "Weak MD5 hash algorithm usage",
			CWEID:         "CWE-328",
			OWASPCategory: "A02:2021-Cryptographic Failures",
		},
		{
			ID:            "groovy.crypto.sha1",
			Category:      taint.SnkCrypto,
			Language:      rules.LangGroovy,
			Pattern:       `MessageDigest\.getInstance\s*\(\s*"SHA-?1"|\.encodeAsSHA1\s*\(`,
			ObjectType:    "MessageDigest",
			MethodName:    "SHA-1",
			DangerousArgs: []int{-1},
			Severity:      rules.Medium,
			Description:   "Weak SHA-1 hash algorithm usage",
			CWEID:         "CWE-328",
			OWASPCategory: "A02:2021-Cryptographic Failures",
		},

		// --- Additional Logging (CWE-117) ---
		{
			ID:            "groovy.log4j",
			Category:      taint.SnkLog,
			Language:      rules.LangGroovy,
			Pattern:       `log\.info\s*\(|log\.warn\s*\(|log\.error\s*\(|log\.debug\s*\(`,
			ObjectType:    "Logger",
			MethodName:    "log.info/warn/error/debug",
			DangerousArgs: []int{0},
			Severity:      rules.Medium,
			Description:   "Log4j/SLF4J logging with potentially tainted data",
			CWEID:         "CWE-117",
			OWASPCategory: "A09:2021-Security Logging and Monitoring Failures",
		},

		// --- HTTP Header Injection (CWE-113) ---
		{
			ID:            "groovy.response.header",
			Category:      taint.SnkHeader,
			Language:      rules.LangGroovy,
			Pattern:       `response\.setHeader\s*\(|response\.addHeader\s*\(`,
			ObjectType:    "HttpServletResponse",
			MethodName:    "setHeader/addHeader",
			DangerousArgs: []int{1},
			Severity:      rules.Medium,
			Description:   "HTTP response header with potentially tainted value",
			CWEID:         "CWE-113",
			OWASPCategory: "A03:2021-Injection",
		},

		// --- File operations (CWE-22) ---
		{
			ID:            "groovy.file.renameto",
			Category:      taint.SnkFileWrite,
			Language:      rules.LangGroovy,
			Pattern:       `\.renameTo\s*\(|new\s+File\(.*\)\.renameTo`,
			ObjectType:    "File",
			MethodName:    "renameTo",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "File rename with potentially tainted destination",
			CWEID:         "CWE-22",
			OWASPCategory: "A01:2021-Broken Access Control",
		},
		{
			ID:            "groovy.files.copy",
			Category:      taint.SnkFileWrite,
			Language:      rules.LangGroovy,
			Pattern:       `Files\.copy\s*\(`,
			ObjectType:    "Files",
			MethodName:    "copy",
			DangerousArgs: []int{0, 1},
			Severity:      rules.High,
			Description:   "NIO file copy with potentially tainted paths",
			CWEID:         "CWE-22",
			OWASPCategory: "A01:2021-Broken Access Control",
		},

		// --- Dynamic code execution (CWE-94) ---
		{
			ID:            "groovy.shell.evaluate.string",
			Category:      taint.SnkEval,
			Language:      rules.LangGroovy,
			Pattern:       `new\s+GroovyShell\s*\(\s*\)\.evaluate\s*\(`,
			ObjectType:    "GroovyShell",
			MethodName:    "evaluate",
			DangerousArgs: []int{0},
			Severity:      rules.Critical,
			Description:   "GroovyShell evaluate with potentially tainted script string",
			CWEID:         "CWE-94",
			OWASPCategory: "A03:2021-Injection",
		},

		// --- SSRF additional ---
		{
			ID:            "groovy.url.text",
			Category:      taint.SnkURLFetch,
			Language:      rules.LangGroovy,
			Pattern:       `new\s+URL\s*\(.*\)\.text|\.toURL\s*\(\s*\)\.text`,
			ObjectType:    "URL",
			MethodName:    "URL.text",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "Groovy URL.text() convenience method with potentially tainted URL (SSRF)",
			CWEID:         "CWE-918",
			OWASPCategory: "A10:2021-Server-Side Request Forgery",
		},

		// --- ReDoS ---
		{
			ID:            "groovy.pattern.compile",
			Category:      taint.SnkEval,
			Language:      rules.LangGroovy,
			Pattern:       `Pattern\.compile\s*\(|~\s*['"]`,
			ObjectType:    "Pattern",
			MethodName:    "compile/~",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "Regex compilation with potentially tainted pattern (ReDoS risk)",
			CWEID:         "CWE-1333",
			OWASPCategory: "A03:2021-Injection",
		},
	}
}
