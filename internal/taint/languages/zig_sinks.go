package languages

import (
	"github.com/turenlabs/batou/internal/rules"
	"github.com/turenlabs/batou/internal/taint"
)

func (c *ZigCatalog) Sinks() []taint.SinkDef {
	return []taint.SinkDef{
		// --- Command Execution (CWE-78) ---
		{
			ID:            "zig.exec.execve",
			Category:      taint.SnkCommand,
			Language:      rules.LangZig,
			Pattern:       `std\.os\.execve\s*\(`,
			ObjectType:    "std.os",
			MethodName:    "std.os.execve",
			DangerousArgs: []int{0},
			Severity:      rules.Critical,
			Description:   "OS execve with potentially tainted program path or arguments",
			CWEID:         "CWE-78",
			OWASPCategory: "A03:2021-Injection",
		},
		{
			ID:            "zig.exec.execvp",
			Category:      taint.SnkCommand,
			Language:      rules.LangZig,
			Pattern:       `std\.os\.execvpe?\s*\(`,
			ObjectType:    "std.os",
			MethodName:    "std.os.execvp",
			DangerousArgs: []int{0},
			Severity:      rules.Critical,
			Description:   "OS execvp with potentially tainted program path",
			CWEID:         "CWE-78",
			OWASPCategory: "A03:2021-Injection",
		},
		{
			ID:            "zig.process.Child.init",
			Category:      taint.SnkCommand,
			Language:      rules.LangZig,
			Pattern:       `std\.process\.Child`,
			ObjectType:    "std.process",
			MethodName:    "std.process.Child",
			DangerousArgs: []int{0},
			Severity:      rules.Critical,
			Description:   "Child process creation with potentially tainted arguments",
			CWEID:         "CWE-78",
			OWASPCategory: "A03:2021-Injection",
		},
		{
			ID:            "zig.process.Child.spawn",
			Category:      taint.SnkCommand,
			Language:      rules.LangZig,
			Pattern:       `\.spawn\s*\(`,
			ObjectType:    "std.process.Child",
			MethodName:    "Child.spawn",
			DangerousArgs: []int{-1},
			Severity:      rules.Critical,
			Description:   "Spawn child process with potentially tainted configuration",
			CWEID:         "CWE-78",
			OWASPCategory: "A03:2021-Injection",
		},

		// --- File Write / Path Traversal (CWE-73) ---
		{
			ID:            "zig.fs.File.write",
			Category:      taint.SnkFileWrite,
			Language:      rules.LangZig,
			Pattern:       `\.write\s*\(`,
			ObjectType:    "std.fs.File",
			MethodName:    "File.write",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "File write with potentially tainted data",
			CWEID:         "CWE-73",
			OWASPCategory: "A01:2021-Broken Access Control",
		},
		{
			ID:            "zig.fs.File.writeAll",
			Category:      taint.SnkFileWrite,
			Language:      rules.LangZig,
			Pattern:       `\.writeAll\s*\(`,
			ObjectType:    "std.fs.File",
			MethodName:    "File.writeAll",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "File writeAll with potentially tainted data",
			CWEID:         "CWE-73",
			OWASPCategory: "A01:2021-Broken Access Control",
		},
		{
			ID:            "zig.fs.Dir.createFile",
			Category:      taint.SnkFileWrite,
			Language:      rules.LangZig,
			Pattern:       `\.createFile\s*\(`,
			ObjectType:    "std.fs.Dir",
			MethodName:    "Dir.createFile",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "File creation with potentially tainted path",
			CWEID:         "CWE-22",
			OWASPCategory: "A01:2021-Broken Access Control",
		},
		{
			ID:            "zig.fs.Dir.deleteFile",
			Category:      taint.SnkFileWrite,
			Language:      rules.LangZig,
			Pattern:       `\.deleteFile\s*\(`,
			ObjectType:    "std.fs.Dir",
			MethodName:    "Dir.deleteFile",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "File deletion with potentially tainted path",
			CWEID:         "CWE-22",
			OWASPCategory: "A01:2021-Broken Access Control",
		},
		{
			ID:            "zig.fs.Dir.rename",
			Category:      taint.SnkFileWrite,
			Language:      rules.LangZig,
			Pattern:       `\.rename\s*\(`,
			ObjectType:    "std.fs.Dir",
			MethodName:    "Dir.rename",
			DangerousArgs: []int{0, 1},
			Severity:      rules.High,
			Description:   "File rename with potentially tainted paths",
			CWEID:         "CWE-22",
			OWASPCategory: "A01:2021-Broken Access Control",
		},
		{
			ID:            "zig.fs.Dir.symLink",
			Category:      taint.SnkFileWrite,
			Language:      rules.LangZig,
			Pattern:       `\.symLink\s*\(`,
			ObjectType:    "std.fs.Dir",
			MethodName:    "Dir.symLink",
			DangerousArgs: []int{0, 1},
			Severity:      rules.High,
			Description:   "Symlink creation with potentially tainted paths",
			CWEID:         "CWE-59",
			OWASPCategory: "A01:2021-Broken Access Control",
		},

		// --- Format String (CWE-134) ---
		{
			ID:            "zig.fmt.format",
			Category:      taint.SnkEval,
			Language:      rules.LangZig,
			Pattern:       `std\.fmt\.format\s*\(`,
			ObjectType:    "std.fmt",
			MethodName:    "std.fmt.format",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "Format string with potentially tainted format template",
			CWEID:         "CWE-134",
			OWASPCategory: "A03:2021-Injection",
		},
		{
			ID:            "zig.fmt.allocPrint",
			Category:      taint.SnkEval,
			Language:      rules.LangZig,
			Pattern:       `std\.fmt\.allocPrint\s*\(`,
			ObjectType:    "std.fmt",
			MethodName:    "std.fmt.allocPrint",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "Allocated format print with potentially tainted format template",
			CWEID:         "CWE-134",
			OWASPCategory: "A03:2021-Injection",
		},
		{
			ID:            "zig.fmt.bufPrint",
			Category:      taint.SnkEval,
			Language:      rules.LangZig,
			Pattern:       `std\.fmt\.bufPrint\s*\(`,
			ObjectType:    "std.fmt",
			MethodName:    "std.fmt.bufPrint",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "Buffer format print with potentially tainted format template",
			CWEID:         "CWE-134",
			OWASPCategory: "A03:2021-Injection",
		},

		// --- HTTP Response (CWE-79) ---
		{
			ID:            "zig.http.response.write",
			Category:      taint.SnkHTMLOutput,
			Language:      rules.LangZig,
			Pattern:       `\.writeAll\s*\(|\.write\s*\(`,
			ObjectType:    "std.http.Server.Response",
			MethodName:    "Response.write",
			DangerousArgs: []int{0},
			Severity:      rules.Medium,
			Description:   "HTTP response write with potentially tainted data (XSS risk)",
			CWEID:         "CWE-79",
			OWASPCategory: "A03:2021-Injection",
		},
		{
			ID:            "zig.http.response.headers",
			Category:      taint.SnkHeader,
			Language:      rules.LangZig,
			Pattern:       `\.response\.headers\.append\s*\(`,
			ObjectType:    "std.http.Server.Response",
			MethodName:    "Response.headers.append",
			DangerousArgs: []int{0, 1},
			Severity:      rules.Medium,
			Description:   "HTTP response header with potentially tainted value",
			CWEID:         "CWE-113",
			OWASPCategory: "A03:2021-Injection",
		},

		// --- Memory Corruption (CWE-787) ---
		{
			ID:            "zig.builtin.ptrCast",
			Category:      taint.SnkCommand,
			Language:      rules.LangZig,
			Pattern:       `@ptrCast\s*\(`,
			ObjectType:    "",
			MethodName:    "@ptrCast",
			DangerousArgs: []int{0},
			Severity:      rules.Critical,
			Description:   "Pointer cast with potentially tainted data (memory corruption risk)",
			CWEID:         "CWE-787",
			OWASPCategory: "A06:2021-Vulnerable and Outdated Components",
		},
		{
			ID:            "zig.builtin.intToPtr",
			Category:      taint.SnkCommand,
			Language:      rules.LangZig,
			Pattern:       `@intToPtr\s*\(`,
			ObjectType:    "",
			MethodName:    "@intToPtr",
			DangerousArgs: []int{0},
			Severity:      rules.Critical,
			Description:   "Integer to pointer conversion with potentially tainted value",
			CWEID:         "CWE-787",
			OWASPCategory: "A06:2021-Vulnerable and Outdated Components",
		},
		{
			ID:            "zig.builtin.ptrFromInt",
			Category:      taint.SnkCommand,
			Language:      rules.LangZig,
			Pattern:       `@ptrFromInt\s*\(`,
			ObjectType:    "",
			MethodName:    "@ptrFromInt",
			DangerousArgs: []int{0},
			Severity:      rules.Critical,
			Description:   "Pointer from integer with potentially tainted value (Zig 0.12+)",
			CWEID:         "CWE-787",
			OWASPCategory: "A06:2021-Vulnerable and Outdated Components",
		},
		{
			ID:            "zig.builtin.alignCast",
			Category:      taint.SnkCommand,
			Language:      rules.LangZig,
			Pattern:       `@alignCast\s*\(`,
			ObjectType:    "",
			MethodName:    "@alignCast",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "Alignment cast with potentially tainted pointer",
			CWEID:         "CWE-787",
			OWASPCategory: "A06:2021-Vulnerable and Outdated Components",
		},

		// --- Log Injection (CWE-117) ---
		{
			ID:            "zig.log.info",
			Category:      taint.SnkLog,
			Language:      rules.LangZig,
			Pattern:       `std\.log\.info\s*\(`,
			ObjectType:    "std.log",
			MethodName:    "std.log.info",
			DangerousArgs: []int{-1},
			Severity:      rules.Medium,
			Description:   "Log output with potentially tainted data",
			CWEID:         "CWE-117",
			OWASPCategory: "A09:2021-Security Logging and Monitoring Failures",
		},
		{
			ID:            "zig.log.warn",
			Category:      taint.SnkLog,
			Language:      rules.LangZig,
			Pattern:       `std\.log\.warn\s*\(`,
			ObjectType:    "std.log",
			MethodName:    "std.log.warn",
			DangerousArgs: []int{-1},
			Severity:      rules.Medium,
			Description:   "Log warning with potentially tainted data",
			CWEID:         "CWE-117",
			OWASPCategory: "A09:2021-Security Logging and Monitoring Failures",
		},
		{
			ID:            "zig.log.err",
			Category:      taint.SnkLog,
			Language:      rules.LangZig,
			Pattern:       `std\.log\.err\s*\(`,
			ObjectType:    "std.log",
			MethodName:    "std.log.err",
			DangerousArgs: []int{-1},
			Severity:      rules.Medium,
			Description:   "Log error with potentially tainted data",
			CWEID:         "CWE-117",
			OWASPCategory: "A09:2021-Security Logging and Monitoring Failures",
		},
	}
}
