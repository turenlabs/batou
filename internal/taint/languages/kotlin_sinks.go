package languages

import (
	"github.com/turenio/gtss/internal/rules"
	"github.com/turenio/gtss/internal/taint"
)

func (c *KotlinCatalog) Sinks() []taint.SinkDef {
	return []taint.SinkDef{
		// --- SQL Injection (CWE-89) ---
		{
			ID:            "kotlin.android.rawquery",
			Category:      taint.SnkSQLQuery,
			Language:      rules.LangKotlin,
			Pattern:       `\.rawQuery\s*\(`,
			ObjectType:    "SQLiteDatabase",
			MethodName:    "rawQuery",
			DangerousArgs: []int{0},
			Severity:      rules.Critical,
			Description:   "Android SQLite rawQuery with potentially tainted input",
			CWEID:         "CWE-89",
			OWASPCategory: "A03:2021-Injection",
		},
		{
			ID:            "kotlin.android.execsql",
			Category:      taint.SnkSQLQuery,
			Language:      rules.LangKotlin,
			Pattern:       `\.execSQL\s*\(`,
			ObjectType:    "SQLiteDatabase",
			MethodName:    "execSQL",
			DangerousArgs: []int{0},
			Severity:      rules.Critical,
			Description:   "Android SQLite execSQL with potentially tainted input",
			CWEID:         "CWE-89",
			OWASPCategory: "A03:2021-Injection",
		},
		{
			ID:            "kotlin.jpa.createquery",
			Category:      taint.SnkSQLQuery,
			Language:      rules.LangKotlin,
			Pattern:       `\.createQuery\s*\(`,
			ObjectType:    "EntityManager",
			MethodName:    "createQuery",
			DangerousArgs: []int{0},
			Severity:      rules.Critical,
			Description:   "JPA createQuery with potentially tainted input",
			CWEID:         "CWE-89",
			OWASPCategory: "A03:2021-Injection",
		},
		{
			ID:            "kotlin.jpa.createnativequery",
			Category:      taint.SnkSQLQuery,
			Language:      rules.LangKotlin,
			Pattern:       `\.createNativeQuery\s*\(`,
			ObjectType:    "EntityManager",
			MethodName:    "createNativeQuery",
			DangerousArgs: []int{0},
			Severity:      rules.Critical,
			Description:   "JPA createNativeQuery with potentially tainted input",
			CWEID:         "CWE-89",
			OWASPCategory: "A03:2021-Injection",
		},
		{
			ID:            "kotlin.exposed.exec",
			Category:      taint.SnkSQLQuery,
			Language:      rules.LangKotlin,
			Pattern:       `\.exec\s*\(|TransactionManager.*exec\s*\(`,
			ObjectType:    "Transaction",
			MethodName:    "exec",
			DangerousArgs: []int{0},
			Severity:      rules.Critical,
			Description:   "Exposed/JDBC raw SQL execution",
			CWEID:         "CWE-89",
			OWASPCategory: "A03:2021-Injection",
		},

		// --- Command Injection (CWE-78) ---
		{
			ID:            "kotlin.runtime.exec",
			Category:      taint.SnkCommand,
			Language:      rules.LangKotlin,
			Pattern:       `Runtime\.getRuntime\s*\(\s*\)\s*\.exec\s*\(`,
			ObjectType:    "Runtime",
			MethodName:    "exec",
			DangerousArgs: []int{0},
			Severity:      rules.Critical,
			Description:   "OS command execution via Runtime.exec",
			CWEID:         "CWE-78",
			OWASPCategory: "A03:2021-Injection",
		},
		{
			ID:            "kotlin.processbuilder",
			Category:      taint.SnkCommand,
			Language:      rules.LangKotlin,
			Pattern:       `ProcessBuilder\s*\(`,
			ObjectType:    "ProcessBuilder",
			MethodName:    "ProcessBuilder",
			DangerousArgs: []int{-1},
			Severity:      rules.Critical,
			Description:   "OS command execution via ProcessBuilder",
			CWEID:         "CWE-78",
			OWASPCategory: "A03:2021-Injection",
		},

		// --- File Operations / Path Traversal (CWE-22) ---
		{
			ID:            "kotlin.file.new",
			Category:      taint.SnkFileWrite,
			Language:      rules.LangKotlin,
			Pattern:       `File\s*\(`,
			ObjectType:    "File",
			MethodName:    "File",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "File path construction with potentially tainted input",
			CWEID:         "CWE-22",
			OWASPCategory: "A01:2021-Broken Access Control",
		},
		{
			ID:            "kotlin.fileinputstream",
			Category:      taint.SnkFileWrite,
			Language:      rules.LangKotlin,
			Pattern:       `FileInputStream\s*\(`,
			ObjectType:    "FileInputStream",
			MethodName:    "FileInputStream",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "FileInputStream with potentially tainted path",
			CWEID:         "CWE-22",
			OWASPCategory: "A01:2021-Broken Access Control",
		},
		{
			ID:            "kotlin.android.openfileoutput",
			Category:      taint.SnkFileWrite,
			Language:      rules.LangKotlin,
			Pattern:       `openFileOutput\s*\(`,
			ObjectType:    "Context",
			MethodName:    "openFileOutput",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "Android file output with potentially tainted filename",
			CWEID:         "CWE-22",
			OWASPCategory: "A01:2021-Broken Access Control",
		},

		// --- XSS / WebView (CWE-79) ---
		{
			ID:            "kotlin.android.webview.loadurl",
			Category:      taint.SnkHTMLOutput,
			Language:      rules.LangKotlin,
			Pattern:       `\.loadUrl\s*\(`,
			ObjectType:    "WebView",
			MethodName:    "loadUrl",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "WebView loadUrl with potentially tainted URL",
			CWEID:         "CWE-79",
			OWASPCategory: "A03:2021-Injection",
		},
		{
			ID:            "kotlin.android.webview.evaluatejavascript",
			Category:      taint.SnkEval,
			Language:      rules.LangKotlin,
			Pattern:       `\.evaluateJavascript\s*\(`,
			ObjectType:    "WebView",
			MethodName:    "evaluateJavascript",
			DangerousArgs: []int{0},
			Severity:      rules.Critical,
			Description:   "WebView JavaScript evaluation with potentially tainted script",
			CWEID:         "CWE-79",
			OWASPCategory: "A03:2021-Injection",
		},
		{
			ID:            "kotlin.ktor.respondtext",
			Category:      taint.SnkHTMLOutput,
			Language:      rules.LangKotlin,
			Pattern:       `call\.respondText\s*\(`,
			ObjectType:    "ApplicationCall",
			MethodName:    "respondText",
			DangerousArgs: []int{0},
			Severity:      rules.Medium,
			Description:   "Ktor response text with potentially tainted data",
			CWEID:         "CWE-79",
			OWASPCategory: "A03:2021-Injection",
		},
		{
			ID:            "kotlin.ktor.respondhtml",
			Category:      taint.SnkHTMLOutput,
			Language:      rules.LangKotlin,
			Pattern:       `call\.respondHtml\s*\(`,
			ObjectType:    "ApplicationCall",
			MethodName:    "respondHtml",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "Ktor HTML response with potentially tainted data",
			CWEID:         "CWE-79",
			OWASPCategory: "A03:2021-Injection",
		},

		// --- Network / SSRF (CWE-918) ---
		{
			ID:            "kotlin.url.openconnection",
			Category:      taint.SnkURLFetch,
			Language:      rules.LangKotlin,
			Pattern:       `URL\s*\(.*\)\s*\.openConnection\s*\(`,
			ObjectType:    "URL",
			MethodName:    "openConnection",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "URL connection with potentially tainted URL (SSRF)",
			CWEID:         "CWE-918",
			OWASPCategory: "A10:2021-Server-Side Request Forgery",
		},
		{
			ID:            "kotlin.url.new",
			Category:      taint.SnkURLFetch,
			Language:      rules.LangKotlin,
			Pattern:       `URL\s*\(`,
			ObjectType:    "URL",
			MethodName:    "URL",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "URL with user-controlled address (SSRF)",
			CWEID:         "CWE-918",
			OWASPCategory: "A10:2021-Server-Side Request Forgery",
		},
		{
			ID:            "kotlin.okhttp.request",
			Category:      taint.SnkURLFetch,
			Language:      rules.LangKotlin,
			Pattern:       `Request\.Builder\s*\(\s*\)\s*\.url\s*\(`,
			ObjectType:    "OkHttp",
			MethodName:    "Request.Builder.url",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "OkHttp request with potentially tainted URL",
			CWEID:         "CWE-918",
			OWASPCategory: "A10:2021-Server-Side Request Forgery",
		},

		// --- Deserialization (CWE-502) ---
		{
			ID:            "kotlin.objectinputstream.readobject",
			Category:      taint.SnkDeserialize,
			Language:      rules.LangKotlin,
			Pattern:       `ObjectInputStream.*\.readObject\s*\(`,
			ObjectType:    "ObjectInputStream",
			MethodName:    "readObject",
			DangerousArgs: []int{-1},
			Severity:      rules.Critical,
			Description:   "Unsafe Java/Kotlin deserialization",
			CWEID:         "CWE-502",
			OWASPCategory: "A08:2021-Software and Data Integrity Failures",
		},
		{
			ID:            "kotlin.gson.fromjson",
			Category:      taint.SnkDeserialize,
			Language:      rules.LangKotlin,
			Pattern:       `Gson\s*\(\s*\)\s*\.fromJson\s*\(|gson\.fromJson\s*\(`,
			ObjectType:    "Gson",
			MethodName:    "fromJson",
			DangerousArgs: []int{0},
			Severity:      rules.Medium,
			Description:   "Gson deserialization of potentially untrusted data",
			CWEID:         "CWE-502",
			OWASPCategory: "A08:2021-Software and Data Integrity Failures",
		},
		{
			ID:            "kotlin.serialization.decodefromstring",
			Category:      taint.SnkDeserialize,
			Language:      rules.LangKotlin,
			Pattern:       `Json\.decodeFromString\s*[<(]|Json\s*\{[^}]*\}\s*\.decodeFromString`,
			ObjectType:    "kotlinx.serialization",
			MethodName:    "decodeFromString",
			DangerousArgs: []int{0},
			Severity:      rules.Medium,
			Description:   "kotlinx.serialization deserialization of potentially untrusted data",
			CWEID:         "CWE-502",
			OWASPCategory: "A08:2021-Software and Data Integrity Failures",
		},

		// --- Log Injection (CWE-117) ---
		{
			ID:            "kotlin.log.info",
			Category:      taint.SnkLog,
			Language:      rules.LangKotlin,
			Pattern:       `(?:logger|Logger|LOG|log)\.info\s*\(`,
			ObjectType:    "Logger",
			MethodName:    "info",
			DangerousArgs: []int{0},
			Severity:      rules.Medium,
			Description:   "Log injection via Logger.info",
			CWEID:         "CWE-117",
			OWASPCategory: "A09:2021-Security Logging and Monitoring Failures",
		},
		{
			ID:            "kotlin.log.error",
			Category:      taint.SnkLog,
			Language:      rules.LangKotlin,
			Pattern:       `(?:logger|Logger|LOG|log)\.error\s*\(`,
			ObjectType:    "Logger",
			MethodName:    "error",
			DangerousArgs: []int{0},
			Severity:      rules.Medium,
			Description:   "Log injection via Logger.error",
			CWEID:         "CWE-117",
			OWASPCategory: "A09:2021-Security Logging and Monitoring Failures",
		},
		{
			ID:            "kotlin.android.log",
			Category:      taint.SnkLog,
			Language:      rules.LangKotlin,
			Pattern:       `Log\.(?:d|i|w|e|v)\s*\(`,
			ObjectType:    "android.util.Log",
			MethodName:    "Log.d/i/w/e/v",
			DangerousArgs: []int{1},
			Severity:      rules.Medium,
			Description:   "Android Log with potentially tainted data",
			CWEID:         "CWE-117",
			OWASPCategory: "A09:2021-Security Logging and Monitoring Failures",
		},

		// --- Redirect (CWE-601) ---
		{
			ID:            "kotlin.ktor.respondredirect",
			Category:      taint.SnkRedirect,
			Language:      rules.LangKotlin,
			Pattern:       `call\.respondRedirect\s*\(`,
			ObjectType:    "ApplicationCall",
			MethodName:    "respondRedirect",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "Ktor redirect with potentially tainted URL",
			CWEID:         "CWE-601",
			OWASPCategory: "A01:2021-Broken Access Control",
		},
	}
}
