package languages

import (
	"github.com/turenlabs/batou/internal/rules"
	"github.com/turenlabs/batou/internal/taint"
)

func (c *KotlinCatalog) Sinks() []taint.SinkDef {
	return []taint.SinkDef{
		// --- SQL Injection (CWE-89) ---
		{
			ID:            "kotlin.android.rawquery",
			Category:      taint.SnkSQLQuery,
			Language:      rules.LangKotlin,
			Pattern:       `\.rawQuery\s*\(`,
			ObjectType:    "SQLiteDatabase",
			MethodName:    "rawQuery",
			DangerousArgs: []int{0},
			Severity:      rules.Critical,
			Description:   "Android SQLite rawQuery with potentially tainted input",
			CWEID:         "CWE-89",
			OWASPCategory: "A03:2021-Injection",
		},
		{
			ID:            "kotlin.android.execsql",
			Category:      taint.SnkSQLQuery,
			Language:      rules.LangKotlin,
			Pattern:       `\.execSQL\s*\(`,
			ObjectType:    "SQLiteDatabase",
			MethodName:    "execSQL",
			DangerousArgs: []int{0},
			Severity:      rules.Critical,
			Description:   "Android SQLite execSQL with potentially tainted input",
			CWEID:         "CWE-89",
			OWASPCategory: "A03:2021-Injection",
		},
		{
			ID:            "kotlin.jpa.createquery",
			Category:      taint.SnkSQLQuery,
			Language:      rules.LangKotlin,
			Pattern:       `\.createQuery\s*\(`,
			ObjectType:    "EntityManager",
			MethodName:    "createQuery",
			DangerousArgs: []int{0},
			Severity:      rules.Critical,
			Description:   "JPA createQuery with potentially tainted input",
			CWEID:         "CWE-89",
			OWASPCategory: "A03:2021-Injection",
		},
		{
			ID:            "kotlin.jpa.createnativequery",
			Category:      taint.SnkSQLQuery,
			Language:      rules.LangKotlin,
			Pattern:       `\.createNativeQuery\s*\(`,
			ObjectType:    "EntityManager",
			MethodName:    "createNativeQuery",
			DangerousArgs: []int{0},
			Severity:      rules.Critical,
			Description:   "JPA createNativeQuery with potentially tainted input",
			CWEID:         "CWE-89",
			OWASPCategory: "A03:2021-Injection",
		},
		{
			ID:            "kotlin.exposed.exec",
			Category:      taint.SnkSQLQuery,
			Language:      rules.LangKotlin,
			Pattern:       `\.exec\s*\(|TransactionManager.*exec\s*\(`,
			ObjectType:    "Transaction",
			MethodName:    "exec",
			DangerousArgs: []int{0},
			Severity:      rules.Critical,
			Description:   "Exposed/JDBC raw SQL execution",
			CWEID:         "CWE-89",
			OWASPCategory: "A03:2021-Injection",
		},

		// --- Command Injection (CWE-78) ---
		{
			ID:            "kotlin.runtime.exec",
			Category:      taint.SnkCommand,
			Language:      rules.LangKotlin,
			Pattern:       `Runtime\.getRuntime\s*\(\s*\)\s*\.exec\s*\(`,
			ObjectType:    "Runtime",
			MethodName:    "exec",
			DangerousArgs: []int{0},
			Severity:      rules.Critical,
			Description:   "OS command execution via Runtime.exec",
			CWEID:         "CWE-78",
			OWASPCategory: "A03:2021-Injection",
		},
		{
			ID:            "kotlin.processbuilder",
			Category:      taint.SnkCommand,
			Language:      rules.LangKotlin,
			Pattern:       `ProcessBuilder\s*\(`,
			ObjectType:    "ProcessBuilder",
			MethodName:    "ProcessBuilder",
			DangerousArgs: []int{-1},
			Severity:      rules.Critical,
			Description:   "OS command execution via ProcessBuilder",
			CWEID:         "CWE-78",
			OWASPCategory: "A03:2021-Injection",
		},

		// --- File Operations / Path Traversal (CWE-22) ---
		{
			ID:            "kotlin.file.new",
			Category:      taint.SnkFileWrite,
			Language:      rules.LangKotlin,
			Pattern:       `File\s*\(`,
			ObjectType:    "File",
			MethodName:    "File",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "File path construction with potentially tainted input",
			CWEID:         "CWE-22",
			OWASPCategory: "A01:2021-Broken Access Control",
		},
		{
			ID:            "kotlin.fileinputstream",
			Category:      taint.SnkFileWrite,
			Language:      rules.LangKotlin,
			Pattern:       `FileInputStream\s*\(`,
			ObjectType:    "FileInputStream",
			MethodName:    "FileInputStream",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "FileInputStream with potentially tainted path",
			CWEID:         "CWE-22",
			OWASPCategory: "A01:2021-Broken Access Control",
		},
		{
			ID:            "kotlin.android.openfileoutput",
			Category:      taint.SnkFileWrite,
			Language:      rules.LangKotlin,
			Pattern:       `openFileOutput\s*\(`,
			ObjectType:    "Context",
			MethodName:    "openFileOutput",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "Android file output with potentially tainted filename",
			CWEID:         "CWE-22",
			OWASPCategory: "A01:2021-Broken Access Control",
		},

		// --- XSS / WebView (CWE-79) ---
		{
			ID:            "kotlin.android.webview.loadurl",
			Category:      taint.SnkHTMLOutput,
			Language:      rules.LangKotlin,
			Pattern:       `\.loadUrl\s*\(`,
			ObjectType:    "WebView",
			MethodName:    "loadUrl",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "WebView loadUrl with potentially tainted URL",
			CWEID:         "CWE-79",
			OWASPCategory: "A03:2021-Injection",
		},
		{
			ID:            "kotlin.android.webview.evaluatejavascript",
			Category:      taint.SnkEval,
			Language:      rules.LangKotlin,
			Pattern:       `\.evaluateJavascript\s*\(`,
			ObjectType:    "WebView",
			MethodName:    "evaluateJavascript",
			DangerousArgs: []int{0},
			Severity:      rules.Critical,
			Description:   "WebView JavaScript evaluation with potentially tainted script",
			CWEID:         "CWE-79",
			OWASPCategory: "A03:2021-Injection",
		},
		{
			ID:            "kotlin.ktor.respondtext",
			Category:      taint.SnkHTMLOutput,
			Language:      rules.LangKotlin,
			Pattern:       `call\.respondText\s*\(`,
			ObjectType:    "ApplicationCall",
			MethodName:    "respondText",
			DangerousArgs: []int{0},
			Severity:      rules.Medium,
			Description:   "Ktor response text with potentially tainted data",
			CWEID:         "CWE-79",
			OWASPCategory: "A03:2021-Injection",
		},
		{
			ID:            "kotlin.ktor.respondhtml",
			Category:      taint.SnkHTMLOutput,
			Language:      rules.LangKotlin,
			Pattern:       `call\.respondHtml\s*\(`,
			ObjectType:    "ApplicationCall",
			MethodName:    "respondHtml",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "Ktor HTML response with potentially tainted data",
			CWEID:         "CWE-79",
			OWASPCategory: "A03:2021-Injection",
		},

		// --- Network / SSRF (CWE-918) ---
		{
			ID:            "kotlin.url.openconnection",
			Category:      taint.SnkURLFetch,
			Language:      rules.LangKotlin,
			Pattern:       `URL\s*\(.*\)\s*\.openConnection\s*\(`,
			ObjectType:    "URL",
			MethodName:    "openConnection",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "URL connection with potentially tainted URL (SSRF)",
			CWEID:         "CWE-918",
			OWASPCategory: "A10:2021-Server-Side Request Forgery",
		},
		{
			ID:            "kotlin.url.new",
			Category:      taint.SnkURLFetch,
			Language:      rules.LangKotlin,
			Pattern:       `URL\s*\(`,
			ObjectType:    "URL",
			MethodName:    "URL",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "URL with user-controlled address (SSRF)",
			CWEID:         "CWE-918",
			OWASPCategory: "A10:2021-Server-Side Request Forgery",
		},
		{
			ID:            "kotlin.okhttp.request",
			Category:      taint.SnkURLFetch,
			Language:      rules.LangKotlin,
			Pattern:       `Request\.Builder\s*\(\s*\)\s*\.url\s*\(`,
			ObjectType:    "OkHttp",
			MethodName:    "Request.Builder.url",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "OkHttp request with potentially tainted URL",
			CWEID:         "CWE-918",
			OWASPCategory: "A10:2021-Server-Side Request Forgery",
		},

		// --- Deserialization (CWE-502) ---
		{
			ID:            "kotlin.objectinputstream.readobject",
			Category:      taint.SnkDeserialize,
			Language:      rules.LangKotlin,
			Pattern:       `ObjectInputStream.*\.readObject\s*\(`,
			ObjectType:    "ObjectInputStream",
			MethodName:    "readObject",
			DangerousArgs: []int{-1},
			Severity:      rules.Critical,
			Description:   "Unsafe Java/Kotlin deserialization",
			CWEID:         "CWE-502",
			OWASPCategory: "A08:2021-Software and Data Integrity Failures",
		},
		{
			ID:            "kotlin.gson.fromjson",
			Category:      taint.SnkDeserialize,
			Language:      rules.LangKotlin,
			Pattern:       `Gson\s*\(\s*\)\s*\.fromJson\s*\(|gson\.fromJson\s*\(`,
			ObjectType:    "Gson",
			MethodName:    "fromJson",
			DangerousArgs: []int{0},
			Severity:      rules.Medium,
			Description:   "Gson deserialization of potentially untrusted data",
			CWEID:         "CWE-502",
			OWASPCategory: "A08:2021-Software and Data Integrity Failures",
		},
		{
			ID:            "kotlin.serialization.decodefromstring",
			Category:      taint.SnkDeserialize,
			Language:      rules.LangKotlin,
			Pattern:       `Json\.decodeFromString\s*[<(]|Json\s*\{[^}]*\}\s*\.decodeFromString`,
			ObjectType:    "kotlinx.serialization",
			MethodName:    "decodeFromString",
			DangerousArgs: []int{0},
			Severity:      rules.Medium,
			Description:   "kotlinx.serialization deserialization of potentially untrusted data",
			CWEID:         "CWE-502",
			OWASPCategory: "A08:2021-Software and Data Integrity Failures",
		},

		// --- Log Injection (CWE-117) ---
		{
			ID:            "kotlin.log.info",
			Category:      taint.SnkLog,
			Language:      rules.LangKotlin,
			Pattern:       `(?:logger|Logger|LOG|log)\.info\s*\(`,
			ObjectType:    "Logger",
			MethodName:    "info",
			DangerousArgs: []int{0},
			Severity:      rules.Medium,
			Description:   "Log injection via Logger.info",
			CWEID:         "CWE-117",
			OWASPCategory: "A09:2021-Security Logging and Monitoring Failures",
		},
		{
			ID:            "kotlin.log.error",
			Category:      taint.SnkLog,
			Language:      rules.LangKotlin,
			Pattern:       `(?:logger|Logger|LOG|log)\.error\s*\(`,
			ObjectType:    "Logger",
			MethodName:    "error",
			DangerousArgs: []int{0},
			Severity:      rules.Medium,
			Description:   "Log injection via Logger.error",
			CWEID:         "CWE-117",
			OWASPCategory: "A09:2021-Security Logging and Monitoring Failures",
		},
		{
			ID:            "kotlin.android.log",
			Category:      taint.SnkLog,
			Language:      rules.LangKotlin,
			Pattern:       `Log\.(?:d|i|w|e|v)\s*\(`,
			ObjectType:    "android.util.Log",
			MethodName:    "Log.d/i/w/e/v",
			DangerousArgs: []int{1},
			Severity:      rules.Medium,
			Description:   "Android Log with potentially tainted data",
			CWEID:         "CWE-117",
			OWASPCategory: "A09:2021-Security Logging and Monitoring Failures",
		},

		// --- Redirect (CWE-601) ---
		{
			ID:            "kotlin.ktor.respondredirect",
			Category:      taint.SnkRedirect,
			Language:      rules.LangKotlin,
			Pattern:       `call\.respondRedirect\s*\(`,
			ObjectType:    "ApplicationCall",
			MethodName:    "respondRedirect",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "Ktor redirect with potentially tainted URL",
			CWEID:         "CWE-601",
			OWASPCategory: "A01:2021-Broken Access Control",
		},

		// --- Template Injection (CWE-1336) ---
		{
			ID:            "kotlin.freemarker.process",
			Category:      taint.SnkTemplate,
			Language:      rules.LangKotlin,
			Pattern:       `template\.process\s*\(|Template\(.*\)\.process\s*\(`,
			ObjectType:    "FreeMarker",
			MethodName:    "Template.process",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "FreeMarker template processing with potentially tainted data",
			CWEID:         "CWE-1336",
			OWASPCategory: "A03:2021-Injection",
		},
		{
			ID:            "kotlin.thymeleaf.process",
			Category:      taint.SnkTemplate,
			Language:      rules.LangKotlin,
			Pattern:       `templateEngine\.process\s*\(|TemplateEngine\(\)\.process\s*\(`,
			ObjectType:    "TemplateEngine",
			MethodName:    "TemplateEngine.process",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "Thymeleaf template processing with potentially tainted context",
			CWEID:         "CWE-1336",
			OWASPCategory: "A03:2021-Injection",
		},
		{
			ID:            "kotlin.ktor.respondhtml",
			Category:      taint.SnkTemplate,
			Language:      rules.LangKotlin,
			Pattern:       `call\.respond\s*\(\s*FreeMarkerContent\(|call\.respond\s*\(\s*ThymeleafContent\(`,
			ObjectType:    "ApplicationCall",
			MethodName:    "respond(FreeMarkerContent/ThymeleafContent)",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "Ktor template response with potentially tainted data",
			CWEID:         "CWE-1336",
			OWASPCategory: "A03:2021-Injection",
		},

		// --- XPath Injection (CWE-643) ---
		{
			ID:            "kotlin.xpath.evaluate",
			Category:      taint.SnkXPath,
			Language:      rules.LangKotlin,
			Pattern:       `XPathFactory.*\.evaluate\s*\(|xpath\.evaluate\s*\(|XPath.*\.compile\s*\(`,
			ObjectType:    "XPath",
			MethodName:    "XPath.evaluate",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "XPath query with potentially tainted expression",
			CWEID:         "CWE-643",
			OWASPCategory: "A03:2021-Injection",
		},

		// --- LDAP Injection (CWE-90) ---
		{
			ID:            "kotlin.ldap.search",
			Category:      taint.SnkLDAP,
			Language:      rules.LangKotlin,
			Pattern:       `\.search\s*\(\s*.*LdapName|DirContext.*\.search\s*\(|InitialDirContext.*\.search\s*\(`,
			ObjectType:    "DirContext",
			MethodName:    "DirContext.search",
			DangerousArgs: []int{1},
			Severity:      rules.High,
			Description:   "LDAP search with potentially tainted filter",
			CWEID:         "CWE-90",
			OWASPCategory: "A03:2021-Injection",
		},

		// --- Weak Crypto (CWE-328) ---
		{
			ID:            "kotlin.crypto.md5",
			Category:      taint.SnkCrypto,
			Language:      rules.LangKotlin,
			Pattern:       `MessageDigest\.getInstance\s*\(\s*"MD5"|MessageDigest\.getInstance\s*\(\s*"md5"`,
			ObjectType:    "MessageDigest",
			MethodName:    "MessageDigest(MD5)",
			DangerousArgs: []int{-1},
			Severity:      rules.Medium,
			Description:   "Weak MD5 hash algorithm usage",
			CWEID:         "CWE-328",
			OWASPCategory: "A02:2021-Cryptographic Failures",
		},
		{
			ID:            "kotlin.crypto.sha1",
			Category:      taint.SnkCrypto,
			Language:      rules.LangKotlin,
			Pattern:       `MessageDigest\.getInstance\s*\(\s*"SHA-?1"`,
			ObjectType:    "MessageDigest",
			MethodName:    "MessageDigest(SHA-1)",
			DangerousArgs: []int{-1},
			Severity:      rules.Medium,
			Description:   "Weak SHA-1 hash algorithm usage",
			CWEID:         "CWE-328",
			OWASPCategory: "A02:2021-Cryptographic Failures",
		},

		// --- HTTP Header Injection (CWE-113) ---
		{
			ID:            "kotlin.ktor.header",
			Category:      taint.SnkHeader,
			Language:      rules.LangKotlin,
			Pattern:       `call\.response\.header\s*\(|call\.response\.headers\.append\s*\(`,
			ObjectType:    "ApplicationCall",
			MethodName:    "response.header",
			DangerousArgs: []int{1},
			Severity:      rules.Medium,
			Description:   "HTTP response header with potentially tainted value",
			CWEID:         "CWE-113",
			OWASPCategory: "A03:2021-Injection",
		},
		{
			ID:            "kotlin.spring.header",
			Category:      taint.SnkHeader,
			Language:      rules.LangKotlin,
			Pattern:       `ResponseEntity.*\.header\s*\(|HttpHeaders\(\)\.set\s*\(`,
			ObjectType:    "ResponseEntity",
			MethodName:    "ResponseEntity.header",
			DangerousArgs: []int{1},
			Severity:      rules.Medium,
			Description:   "Spring response header with potentially tainted value",
			CWEID:         "CWE-113",
			OWASPCategory: "A03:2021-Injection",
		},

		// --- WebView loadData (CWE-79) ---
		{
			ID:            "kotlin.android.webview.loaddata",
			Category:      taint.SnkHTMLOutput,
			Language:      rules.LangKotlin,
			Pattern:       `\.loadData\s*\(|\.loadDataWithBaseURL\s*\(`,
			ObjectType:    "WebView",
			MethodName:    "loadData/loadDataWithBaseURL",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "WebView loadData with potentially tainted HTML content",
			CWEID:         "CWE-79",
			OWASPCategory: "A03:2021-Injection",
		},

		// --- File operations (CWE-22) ---
		{
			ID:            "kotlin.files.write",
			Category:      taint.SnkFileWrite,
			Language:      rules.LangKotlin,
			Pattern:       `Files\.write\s*\(|\.writeText\s*\(|\.writeBytes\s*\(`,
			ObjectType:    "Files",
			MethodName:    "write/writeText/writeBytes",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "File write with potentially tainted path or content",
			CWEID:         "CWE-22",
			OWASPCategory: "A01:2021-Broken Access Control",
		},
		{
			ID:            "kotlin.files.copy",
			Category:      taint.SnkFileWrite,
			Language:      rules.LangKotlin,
			Pattern:       `Files\.copy\s*\(|\.copyTo\s*\(`,
			ObjectType:    "Files",
			MethodName:    "copy/copyTo",
			DangerousArgs: []int{0, 1},
			Severity:      rules.High,
			Description:   "File copy with potentially tainted paths",
			CWEID:         "CWE-22",
			OWASPCategory: "A01:2021-Broken Access Control",
		},

		// --- ReDoS (CWE-1333) ---
		{
			ID:            "kotlin.regex.construct",
			Category:      taint.SnkEval,
			Language:      rules.LangKotlin,
			Pattern:       `Regex\s*\(|\.toRegex\s*\(`,
			ObjectType:    "Regex",
			MethodName:    "Regex/toRegex",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "Regex construction with potentially tainted pattern (ReDoS risk)",
			CWEID:         "CWE-1333",
			OWASPCategory: "A03:2021-Injection",
		},

		// --- SSRF additional ---
		{
			ID:            "kotlin.ktor.client.request",
			Category:      taint.SnkURLFetch,
			Language:      rules.LangKotlin,
			Pattern:       `client\.get\s*\(|client\.post\s*\(|client\.request\s*\(`,
			ObjectType:    "io.ktor.client.HttpClient",
			MethodName:    "get/post/request",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "Ktor HTTP client request with potentially tainted URL (SSRF)",
			CWEID:         "CWE-918",
			OWASPCategory: "A10:2021-Server-Side Request Forgery",
		},

		// --- Android Intent redirect ---
		{
			ID:            "kotlin.android.startactivity",
			Category:      taint.SnkRedirect,
			Language:      rules.LangKotlin,
			Pattern:       `startActivity\s*\(|startActivityForResult\s*\(`,
			ObjectType:    "android.app.Activity",
			MethodName:    "startActivity",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "Android activity launch with potentially tainted intent",
			CWEID:         "CWE-926",
			OWASPCategory: "A01:2021-Broken Access Control",
		},

		// --- Cookie injection ---
		{
			ID:            "kotlin.ktor.cookie",
			Category:      taint.SnkHeader,
			Language:      rules.LangKotlin,
			Pattern:       `call\.response\.cookies\.append\s*\(`,
			ObjectType:    "io.ktor.server.response",
			MethodName:    "cookies.append",
			DangerousArgs: []int{0, 1},
			Severity:      rules.Medium,
			Description:   "Ktor cookie set with potentially tainted value",
			CWEID:         "CWE-113",
			OWASPCategory: "A03:2021-Injection",
		},
	}
}
