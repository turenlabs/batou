package languages

import (
	"github.com/turenio/gtss/internal/rules"
	"github.com/turenio/gtss/internal/taint"
)

func (c *RustCatalog) Sinks() []taint.SinkDef {
	return []taint.SinkDef{
		// --- Command Injection (CWE-78) ---
		{
			ID:            "rust.exec.command_new",
			Category:      taint.SnkCommand,
			Language:      rules.LangRust,
			Pattern:       `Command::new\s*\(`,
			ObjectType:    "std::process",
			MethodName:    "Command::new",
			DangerousArgs: []int{0},
			Severity:      rules.Critical,
			Description:   "OS command execution with potentially tainted program name",
			CWEID:         "CWE-78",
			OWASPCategory: "A03:2021-Injection",
		},
		{
			ID:            "rust.exec.command_arg",
			Category:      taint.SnkCommand,
			Language:      rules.LangRust,
			Pattern:       `\.arg\s*\(`,
			ObjectType:    "std::process::Command",
			MethodName:    "Command::arg",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "OS command argument with potentially tainted input",
			CWEID:         "CWE-78",
			OWASPCategory: "A03:2021-Injection",
		},

		// --- SQL Injection (CWE-89) ---
		{
			ID:            "rust.sql.sqlx_query",
			Category:      taint.SnkSQLQuery,
			Language:      rules.LangRust,
			Pattern:       `sqlx::query\s*\(`,
			ObjectType:    "sqlx",
			MethodName:    "sqlx::query",
			DangerousArgs: []int{0},
			Severity:      rules.Critical,
			Description:   "SQLx query with potentially tainted SQL string",
			CWEID:         "CWE-89",
			OWASPCategory: "A03:2021-Injection",
		},
		{
			ID:            "rust.sql.diesel_raw",
			Category:      taint.SnkSQLQuery,
			Language:      rules.LangRust,
			Pattern:       `diesel::sql_query\s*\(`,
			ObjectType:    "diesel",
			MethodName:    "diesel::sql_query",
			DangerousArgs: []int{0},
			Severity:      rules.Critical,
			Description:   "Diesel raw SQL query with potentially tainted input",
			CWEID:         "CWE-89",
			OWASPCategory: "A03:2021-Injection",
		},
		{
			ID:            "rust.sql.rusqlite_execute",
			Category:      taint.SnkSQLQuery,
			Language:      rules.LangRust,
			Pattern:       `\.execute\s*\(`,
			ObjectType:    "rusqlite",
			MethodName:    "Connection::execute",
			DangerousArgs: []int{0},
			Severity:      rules.Critical,
			Description:   "Rusqlite SQL execution with potentially tainted query",
			CWEID:         "CWE-89",
			OWASPCategory: "A03:2021-Injection",
		},

		// --- File Operations / Path Traversal (CWE-22) ---
		{
			ID:            "rust.fs.read",
			Category:      taint.SnkFileWrite,
			Language:      rules.LangRust,
			Pattern:       `(?:std::)?fs::read\s*\(`,
			ObjectType:    "std::fs",
			MethodName:    "fs::read",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "File read with potentially tainted path",
			CWEID:         "CWE-22",
			OWASPCategory: "A01:2021-Broken Access Control",
		},
		{
			ID:            "rust.fs.write",
			Category:      taint.SnkFileWrite,
			Language:      rules.LangRust,
			Pattern:       `(?:std::)?fs::write\s*\(`,
			ObjectType:    "std::fs",
			MethodName:    "fs::write",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "File write with potentially tainted path",
			CWEID:         "CWE-22",
			OWASPCategory: "A01:2021-Broken Access Control",
		},
		{
			ID:            "rust.fs.remove_file",
			Category:      taint.SnkFileWrite,
			Language:      rules.LangRust,
			Pattern:       `(?:std::)?fs::remove_file\s*\(`,
			ObjectType:    "std::fs",
			MethodName:    "fs::remove_file",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "File removal with potentially tainted path",
			CWEID:         "CWE-22",
			OWASPCategory: "A01:2021-Broken Access Control",
		},
		{
			ID:            "rust.fs.remove_dir",
			Category:      taint.SnkFileWrite,
			Language:      rules.LangRust,
			Pattern:       `(?:std::)?fs::remove_dir_all\s*\(`,
			ObjectType:    "std::fs",
			MethodName:    "fs::remove_dir_all",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "Directory removal with potentially tainted path",
			CWEID:         "CWE-22",
			OWASPCategory: "A01:2021-Broken Access Control",
		},
		{
			ID:            "rust.tokio.fs.read",
			Category:      taint.SnkFileWrite,
			Language:      rules.LangRust,
			Pattern:       `tokio::fs::read\s*\(`,
			ObjectType:    "tokio::fs",
			MethodName:    "tokio::fs::read",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "Async file read with potentially tainted path",
			CWEID:         "CWE-22",
			OWASPCategory: "A01:2021-Broken Access Control",
		},
		{
			ID:            "rust.tokio.fs.write",
			Category:      taint.SnkFileWrite,
			Language:      rules.LangRust,
			Pattern:       `tokio::fs::write\s*\(`,
			ObjectType:    "tokio::fs",
			MethodName:    "tokio::fs::write",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "Async file write with potentially tainted path",
			CWEID:         "CWE-22",
			OWASPCategory: "A01:2021-Broken Access Control",
		},

		// --- Unsafe Memory Operations ---
		{
			ID:            "rust.ptr.transmute",
			Category:      taint.SnkCommand,
			Language:      rules.LangRust,
			Pattern:       `(?:std::mem::)?transmute\s*[:<(]`,
			ObjectType:    "std::mem",
			MethodName:    "transmute",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "Unsafe type transmutation with potentially tainted data",
			CWEID:         "CWE-704",
			OWASPCategory: "A06:2021-Vulnerable and Outdated Components",
		},
		{
			ID:            "rust.ptr.from_raw_parts",
			Category:      taint.SnkCommand,
			Language:      rules.LangRust,
			Pattern:       `from_raw_parts\s*\(`,
			ObjectType:    "std::slice",
			MethodName:    "from_raw_parts",
			DangerousArgs: []int{0, 1},
			Severity:      rules.High,
			Description:   "Unsafe slice construction from raw pointer with potentially tainted length",
			CWEID:         "CWE-119",
			OWASPCategory: "A06:2021-Vulnerable and Outdated Components",
		},

		// --- XSS / HTML Output (CWE-79) ---
		{
			ID:            "rust.actix.response.body",
			Category:      taint.SnkHTMLOutput,
			Language:      rules.LangRust,
			Pattern:       `HttpResponse(?:Builder)?\s*::\s*\w+\s*\(\s*\)\s*\.\s*body\s*\(`,
			ObjectType:    "actix_web",
			MethodName:    "HttpResponse::body",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "HTTP response body with potentially tainted user data (XSS risk)",
			CWEID:         "CWE-79",
			OWASPCategory: "A03:2021-Injection",
		},

		// --- URL Fetch / SSRF (CWE-918) ---
		{
			ID:            "rust.reqwest.get",
			Category:      taint.SnkURLFetch,
			Language:      rules.LangRust,
			Pattern:       `reqwest::get\s*\(`,
			ObjectType:    "reqwest",
			MethodName:    "reqwest::get",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "HTTP request with potentially tainted URL (SSRF risk)",
			CWEID:         "CWE-918",
			OWASPCategory: "A10:2021-Server-Side Request Forgery",
		},
		{
			ID:            "rust.reqwest.client_get",
			Category:      taint.SnkURLFetch,
			Language:      rules.LangRust,
			Pattern:       `\.get\s*\(\s*&?\s*url`,
			ObjectType:    "reqwest::Client",
			MethodName:    "Client::get",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "HTTP client request with potentially tainted URL",
			CWEID:         "CWE-918",
			OWASPCategory: "A10:2021-Server-Side Request Forgery",
		},

		// --- Open Redirect (CWE-601) ---
		{
			ID:            "rust.redirect",
			Category:      taint.SnkRedirect,
			Language:      rules.LangRust,
			Pattern:       `Redirect::to\s*\(`,
			ObjectType:    "actix_web",
			MethodName:    "Redirect::to",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "HTTP redirect with potentially tainted URL",
			CWEID:         "CWE-601",
			OWASPCategory: "A01:2021-Broken Access Control",
		},

		// --- Deserialization (CWE-502) ---
		{
			ID:            "rust.bincode.deserialize",
			Category:      taint.SnkDeserialize,
			Language:      rules.LangRust,
			Pattern:       `bincode::deserialize\s*\(`,
			ObjectType:    "bincode",
			MethodName:    "bincode::deserialize",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "Binary deserialization of potentially untrusted data",
			CWEID:         "CWE-502",
			OWASPCategory: "A08:2021-Software and Data Integrity Failures",
		},

		// --- Log Injection (CWE-117) ---
		{
			ID:            "rust.log.info",
			Category:      taint.SnkLog,
			Language:      rules.LangRust,
			Pattern:       `(?:log::)?info!\s*\(`,
			ObjectType:    "log",
			MethodName:    "info!",
			DangerousArgs: []int{-1},
			Severity:      rules.Medium,
			Description:   "Log macro with potentially tainted data",
			CWEID:         "CWE-117",
			OWASPCategory: "A09:2021-Security Logging and Monitoring Failures",
		},
		{
			ID:            "rust.tracing.info",
			Category:      taint.SnkLog,
			Language:      rules.LangRust,
			Pattern:       `tracing::info!\s*\(`,
			ObjectType:    "tracing",
			MethodName:    "tracing::info!",
			DangerousArgs: []int{-1},
			Severity:      rules.Medium,
			Description:   "Tracing macro with potentially tainted data",
			CWEID:         "CWE-117",
			OWASPCategory: "A09:2021-Security Logging and Monitoring Failures",
		},

		// --- Template Injection (CWE-1336) ---
		{
			ID:            "rust.tera.render",
			Category:      taint.SnkTemplate,
			Language:      rules.LangRust,
			Pattern:       `tera\.render\s*\(|Tera::one_off\s*\(`,
			ObjectType:    "tera",
			MethodName:    "tera::render",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "Tera template rendering with potentially tainted context",
			CWEID:         "CWE-1336",
			OWASPCategory: "A03:2021-Injection",
		},
		{
			ID:            "rust.handlebars.render",
			Category:      taint.SnkTemplate,
			Language:      rules.LangRust,
			Pattern:       `handlebars\.render\s*\(|handlebars\.render_template\s*\(`,
			ObjectType:    "handlebars",
			MethodName:    "handlebars::render",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "Handlebars template rendering with potentially tainted data",
			CWEID:         "CWE-1336",
			OWASPCategory: "A03:2021-Injection",
		},
		{
			ID:            "rust.askama.render",
			Category:      taint.SnkTemplate,
			Language:      rules.LangRust,
			Pattern:       `\.render\s*\(\s*\).*Template`,
			ObjectType:    "askama",
			MethodName:    "Template::render",
			DangerousArgs: []int{-1},
			Severity:      rules.High,
			Description:   "Askama template rendering with potentially tainted fields",
			CWEID:         "CWE-1336",
			OWASPCategory: "A03:2021-Injection",
		},

		// --- Weak Crypto (CWE-328) ---
		{
			ID:            "rust.crypto.md5",
			Category:      taint.SnkCrypto,
			Language:      rules.LangRust,
			Pattern:       `md5::compute\s*\(|Md5::digest\s*\(|md5::Md5`,
			ObjectType:    "md5",
			MethodName:    "md5::compute",
			DangerousArgs: []int{0},
			Severity:      rules.Medium,
			Description:   "Weak MD5 hash algorithm usage",
			CWEID:         "CWE-328",
			OWASPCategory: "A02:2021-Cryptographic Failures",
		},
		{
			ID:            "rust.crypto.sha1",
			Category:      taint.SnkCrypto,
			Language:      rules.LangRust,
			Pattern:       `Sha1::digest\s*\(|sha1::Sha1`,
			ObjectType:    "sha1",
			MethodName:    "sha1::digest",
			DangerousArgs: []int{0},
			Severity:      rules.Medium,
			Description:   "Weak SHA-1 hash algorithm usage",
			CWEID:         "CWE-328",
			OWASPCategory: "A02:2021-Cryptographic Failures",
		},

		// --- HTTP Header Injection (CWE-113) ---
		{
			ID:            "rust.actix.header",
			Category:      taint.SnkHeader,
			Language:      rules.LangRust,
			Pattern:       `\.insert_header\s*\(|\.append_header\s*\(`,
			ObjectType:    "actix_web",
			MethodName:    "insert_header/append_header",
			DangerousArgs: []int{0},
			Severity:      rules.Medium,
			Description:   "HTTP response header with potentially tainted value",
			CWEID:         "CWE-113",
			OWASPCategory: "A03:2021-Injection",
		},

		// --- Additional log sinks ---
		{
			ID:            "rust.log.warn",
			Category:      taint.SnkLog,
			Language:      rules.LangRust,
			Pattern:       `(?:log::)?warn!\s*\(`,
			ObjectType:    "log",
			MethodName:    "warn!",
			DangerousArgs: []int{-1},
			Severity:      rules.Medium,
			Description:   "Log warn macro with potentially tainted data",
			CWEID:         "CWE-117",
			OWASPCategory: "A09:2021-Security Logging and Monitoring Failures",
		},
		{
			ID:            "rust.log.error",
			Category:      taint.SnkLog,
			Language:      rules.LangRust,
			Pattern:       `(?:log::)?error!\s*\(`,
			ObjectType:    "log",
			MethodName:    "error!",
			DangerousArgs: []int{-1},
			Severity:      rules.Medium,
			Description:   "Log error macro with potentially tainted data",
			CWEID:         "CWE-117",
			OWASPCategory: "A09:2021-Security Logging and Monitoring Failures",
		},

		// --- tokio-postgres ---
		{
			ID:            "rust.tokio.postgres.query",
			Category:      taint.SnkSQLQuery,
			Language:      rules.LangRust,
			Pattern:       `client\.query\s*\(|client\.execute\s*\(|client\.batch_execute\s*\(`,
			ObjectType:    "tokio_postgres",
			MethodName:    "Client::query/execute",
			DangerousArgs: []int{0},
			Severity:      rules.Critical,
			Description:   "tokio-postgres query with potentially tainted SQL",
			CWEID:         "CWE-89",
			OWASPCategory: "A03:2021-Injection",
		},

		// --- sea-orm raw SQL ---
		{
			ID:            "rust.seaorm.rawsql",
			Category:      taint.SnkSQLQuery,
			Language:      rules.LangRust,
			Pattern:       `Statement::from_string\s*\(|Statement::from_sql_and_values\s*\(`,
			ObjectType:    "sea_orm",
			MethodName:    "Statement::from_string",
			DangerousArgs: []int{0},
			Severity:      rules.Critical,
			Description:   "SeaORM raw SQL statement with potentially tainted input",
			CWEID:         "CWE-89",
			OWASPCategory: "A03:2021-Injection",
		},

		// --- File operations (CWE-22) ---
		{
			ID:            "rust.fs.copy",
			Category:      taint.SnkFileWrite,
			Language:      rules.LangRust,
			Pattern:       `std::fs::copy\s*\(|fs::copy\s*\(`,
			ObjectType:    "std::fs",
			MethodName:    "copy",
			DangerousArgs: []int{0, 1},
			Severity:      rules.High,
			Description:   "File copy with potentially tainted paths",
			CWEID:         "CWE-22",
			OWASPCategory: "A01:2021-Broken Access Control",
		},
		{
			ID:            "rust.fs.rename",
			Category:      taint.SnkFileWrite,
			Language:      rules.LangRust,
			Pattern:       `std::fs::rename\s*\(|fs::rename\s*\(`,
			ObjectType:    "std::fs",
			MethodName:    "rename",
			DangerousArgs: []int{0, 1},
			Severity:      rules.High,
			Description:   "File rename with potentially tainted paths",
			CWEID:         "CWE-22",
			OWASPCategory: "A01:2021-Broken Access Control",
		},
		{
			ID:            "rust.symlink",
			Category:      taint.SnkFileWrite,
			Language:      rules.LangRust,
			Pattern:       `std::os::unix::fs::symlink\s*\(|symlink\s*\(`,
			ObjectType:    "std::os::unix::fs",
			MethodName:    "symlink",
			DangerousArgs: []int{0, 1},
			Severity:      rules.High,
			Description:   "Symlink creation with potentially tainted paths",
			CWEID:         "CWE-59",
			OWASPCategory: "A01:2021-Broken Access Control",
		},

		// --- ReDoS (CWE-1333) ---
		{
			ID:            "rust.regex.new",
			Category:      taint.SnkEval,
			Language:      rules.LangRust,
			Pattern:       `Regex::new\s*\(`,
			ObjectType:    "regex::Regex",
			MethodName:    "new",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "Regex construction with potentially tainted pattern (ReDoS risk)",
			CWEID:         "CWE-1333",
			OWASPCategory: "A03:2021-Injection",
		},

		// --- Unsafe deserialization ---
		{
			ID:            "rust.bincode.deserialize_from",
			Category:      taint.SnkDeserialize,
			Language:      rules.LangRust,
			Pattern:       `bincode::deserialize\s*\(|bincode::deserialize_from\s*\(`,
			ObjectType:    "bincode",
			MethodName:    "deserialize",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "Binary deserialization from potentially tainted data",
			CWEID:         "CWE-502",
			OWASPCategory: "A08:2021-Software and Data Integrity Failures",
		},

		// --- SQL with format! macro (CWE-89) ---
		{
			ID:            "rust.sql.format_query",
			Category:      taint.SnkSQLQuery,
			Language:      rules.LangRust,
			Pattern:       `format!\s*\(\s*"(?:SELECT|INSERT|UPDATE|DELETE|DROP)`,
			ObjectType:    "",
			MethodName:    "format! SQL",
			DangerousArgs: []int{-1},
			Severity:      rules.Critical,
			Description:   "SQL query built with format! macro (SQL injection risk)",
			CWEID:         "CWE-89",
			OWASPCategory: "A03:2021-Injection",
		},

		// --- Tokio fs operations (CWE-22) ---
		{
			ID:            "rust.tokio.fs.remove",
			Category:      taint.SnkFileWrite,
			Language:      rules.LangRust,
			Pattern:       `tokio::fs::remove_file\s*\(|tokio::fs::remove_dir_all\s*\(`,
			ObjectType:    "tokio::fs",
			MethodName:    "tokio::fs::remove_file/remove_dir_all",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "Async file/directory removal with potentially tainted path",
			CWEID:         "CWE-22",
			OWASPCategory: "A01:2021-Broken Access Control",
		},

		// --- Tera render_str (CWE-1336) ---
		{
			ID:            "rust.tera.render_str",
			Category:      taint.SnkTemplate,
			Language:      rules.LangRust,
			Pattern:       `Tera::one_off\s*\(|tera\.render_str\s*\(`,
			ObjectType:    "tera",
			MethodName:    "Tera::one_off/render_str",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "Tera template rendering from user-controlled string",
			CWEID:         "CWE-1336",
			OWASPCategory: "A03:2021-Injection",
		},

		// --- reqwest Client URL fetch (CWE-918) ---
		{
			ID:            "rust.reqwest.client_post",
			Category:      taint.SnkURLFetch,
			Language:      rules.LangRust,
			Pattern:       `client\.post\s*\(|client\.put\s*\(|client\.delete\s*\(`,
			ObjectType:    "reqwest::Client",
			MethodName:    "Client::post/put/delete",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "HTTP client request with potentially tainted URL (SSRF)",
			CWEID:         "CWE-918",
			OWASPCategory: "A10:2021-Server-Side Request Forgery",
		},

		// --- serde_json from user data (CWE-502) ---
		{
			ID:            "rust.serde.from_value",
			Category:      taint.SnkDeserialize,
			Language:      rules.LangRust,
			Pattern:       `serde_json::from_value\s*\(`,
			ObjectType:    "serde_json",
			MethodName:    "serde_json::from_value",
			DangerousArgs: []int{0},
			Severity:      rules.Medium,
			Description:   "JSON deserialization from potentially tainted Value",
			CWEID:         "CWE-502",
			OWASPCategory: "A08:2021-Software and Data Integrity Failures",
		},

		// --- log::debug with user data (CWE-117) ---
		{
			ID:            "rust.log.debug",
			Category:      taint.SnkLog,
			Language:      rules.LangRust,
			Pattern:       `(?:log::)?debug!\s*\(`,
			ObjectType:    "log",
			MethodName:    "debug!",
			DangerousArgs: []int{-1},
			Severity:      rules.Medium,
			Description:   "Log debug macro with potentially tainted data",
			CWEID:         "CWE-117",
			OWASPCategory: "A09:2021-Security Logging and Monitoring Failures",
		},
	}
}
