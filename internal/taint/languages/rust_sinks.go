package languages

import (
	"github.com/turenio/gtss/internal/rules"
	"github.com/turenio/gtss/internal/taint"
)

func (c *RustCatalog) Sinks() []taint.SinkDef {
	return []taint.SinkDef{
		// --- Command Injection (CWE-78) ---
		{
			ID:            "rust.exec.command_new",
			Category:      taint.SnkCommand,
			Language:      rules.LangRust,
			Pattern:       `Command::new\s*\(`,
			ObjectType:    "std::process",
			MethodName:    "Command::new",
			DangerousArgs: []int{0},
			Severity:      rules.Critical,
			Description:   "OS command execution with potentially tainted program name",
			CWEID:         "CWE-78",
			OWASPCategory: "A03:2021-Injection",
		},
		{
			ID:            "rust.exec.command_arg",
			Category:      taint.SnkCommand,
			Language:      rules.LangRust,
			Pattern:       `\.arg\s*\(`,
			ObjectType:    "std::process::Command",
			MethodName:    "Command::arg",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "OS command argument with potentially tainted input",
			CWEID:         "CWE-78",
			OWASPCategory: "A03:2021-Injection",
		},

		// --- SQL Injection (CWE-89) ---
		{
			ID:            "rust.sql.sqlx_query",
			Category:      taint.SnkSQLQuery,
			Language:      rules.LangRust,
			Pattern:       `sqlx::query\s*\(`,
			ObjectType:    "sqlx",
			MethodName:    "sqlx::query",
			DangerousArgs: []int{0},
			Severity:      rules.Critical,
			Description:   "SQLx query with potentially tainted SQL string",
			CWEID:         "CWE-89",
			OWASPCategory: "A03:2021-Injection",
		},
		{
			ID:            "rust.sql.diesel_raw",
			Category:      taint.SnkSQLQuery,
			Language:      rules.LangRust,
			Pattern:       `diesel::sql_query\s*\(`,
			ObjectType:    "diesel",
			MethodName:    "diesel::sql_query",
			DangerousArgs: []int{0},
			Severity:      rules.Critical,
			Description:   "Diesel raw SQL query with potentially tainted input",
			CWEID:         "CWE-89",
			OWASPCategory: "A03:2021-Injection",
		},
		{
			ID:            "rust.sql.rusqlite_execute",
			Category:      taint.SnkSQLQuery,
			Language:      rules.LangRust,
			Pattern:       `\.execute\s*\(`,
			ObjectType:    "rusqlite",
			MethodName:    "Connection::execute",
			DangerousArgs: []int{0},
			Severity:      rules.Critical,
			Description:   "Rusqlite SQL execution with potentially tainted query",
			CWEID:         "CWE-89",
			OWASPCategory: "A03:2021-Injection",
		},

		// --- File Operations / Path Traversal (CWE-22) ---
		{
			ID:            "rust.fs.read",
			Category:      taint.SnkFileWrite,
			Language:      rules.LangRust,
			Pattern:       `(?:std::)?fs::read\s*\(`,
			ObjectType:    "std::fs",
			MethodName:    "fs::read",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "File read with potentially tainted path",
			CWEID:         "CWE-22",
			OWASPCategory: "A01:2021-Broken Access Control",
		},
		{
			ID:            "rust.fs.write",
			Category:      taint.SnkFileWrite,
			Language:      rules.LangRust,
			Pattern:       `(?:std::)?fs::write\s*\(`,
			ObjectType:    "std::fs",
			MethodName:    "fs::write",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "File write with potentially tainted path",
			CWEID:         "CWE-22",
			OWASPCategory: "A01:2021-Broken Access Control",
		},
		{
			ID:            "rust.fs.remove_file",
			Category:      taint.SnkFileWrite,
			Language:      rules.LangRust,
			Pattern:       `(?:std::)?fs::remove_file\s*\(`,
			ObjectType:    "std::fs",
			MethodName:    "fs::remove_file",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "File removal with potentially tainted path",
			CWEID:         "CWE-22",
			OWASPCategory: "A01:2021-Broken Access Control",
		},
		{
			ID:            "rust.fs.remove_dir",
			Category:      taint.SnkFileWrite,
			Language:      rules.LangRust,
			Pattern:       `(?:std::)?fs::remove_dir_all\s*\(`,
			ObjectType:    "std::fs",
			MethodName:    "fs::remove_dir_all",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "Directory removal with potentially tainted path",
			CWEID:         "CWE-22",
			OWASPCategory: "A01:2021-Broken Access Control",
		},
		{
			ID:            "rust.tokio.fs.read",
			Category:      taint.SnkFileWrite,
			Language:      rules.LangRust,
			Pattern:       `tokio::fs::read\s*\(`,
			ObjectType:    "tokio::fs",
			MethodName:    "tokio::fs::read",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "Async file read with potentially tainted path",
			CWEID:         "CWE-22",
			OWASPCategory: "A01:2021-Broken Access Control",
		},
		{
			ID:            "rust.tokio.fs.write",
			Category:      taint.SnkFileWrite,
			Language:      rules.LangRust,
			Pattern:       `tokio::fs::write\s*\(`,
			ObjectType:    "tokio::fs",
			MethodName:    "tokio::fs::write",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "Async file write with potentially tainted path",
			CWEID:         "CWE-22",
			OWASPCategory: "A01:2021-Broken Access Control",
		},

		// --- Unsafe Memory Operations ---
		{
			ID:            "rust.ptr.transmute",
			Category:      taint.SnkCommand,
			Language:      rules.LangRust,
			Pattern:       `(?:std::mem::)?transmute\s*[:<(]`,
			ObjectType:    "std::mem",
			MethodName:    "transmute",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "Unsafe type transmutation with potentially tainted data",
			CWEID:         "CWE-704",
			OWASPCategory: "A06:2021-Vulnerable and Outdated Components",
		},
		{
			ID:            "rust.ptr.from_raw_parts",
			Category:      taint.SnkCommand,
			Language:      rules.LangRust,
			Pattern:       `from_raw_parts\s*\(`,
			ObjectType:    "std::slice",
			MethodName:    "from_raw_parts",
			DangerousArgs: []int{0, 1},
			Severity:      rules.High,
			Description:   "Unsafe slice construction from raw pointer with potentially tainted length",
			CWEID:         "CWE-119",
			OWASPCategory: "A06:2021-Vulnerable and Outdated Components",
		},

		// --- XSS / HTML Output (CWE-79) ---
		{
			ID:            "rust.actix.response.body",
			Category:      taint.SnkHTMLOutput,
			Language:      rules.LangRust,
			Pattern:       `HttpResponse(?:Builder)?\s*::\s*\w+\s*\(\s*\)\s*\.\s*body\s*\(`,
			ObjectType:    "actix_web",
			MethodName:    "HttpResponse::body",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "HTTP response body with potentially tainted user data (XSS risk)",
			CWEID:         "CWE-79",
			OWASPCategory: "A03:2021-Injection",
		},

		// --- URL Fetch / SSRF (CWE-918) ---
		{
			ID:            "rust.reqwest.get",
			Category:      taint.SnkURLFetch,
			Language:      rules.LangRust,
			Pattern:       `reqwest::get\s*\(`,
			ObjectType:    "reqwest",
			MethodName:    "reqwest::get",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "HTTP request with potentially tainted URL (SSRF risk)",
			CWEID:         "CWE-918",
			OWASPCategory: "A10:2021-Server-Side Request Forgery",
		},
		{
			ID:            "rust.reqwest.client_get",
			Category:      taint.SnkURLFetch,
			Language:      rules.LangRust,
			Pattern:       `\.get\s*\(\s*&?\s*url`,
			ObjectType:    "reqwest::Client",
			MethodName:    "Client::get",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "HTTP client request with potentially tainted URL",
			CWEID:         "CWE-918",
			OWASPCategory: "A10:2021-Server-Side Request Forgery",
		},

		// --- Open Redirect (CWE-601) ---
		{
			ID:            "rust.redirect",
			Category:      taint.SnkRedirect,
			Language:      rules.LangRust,
			Pattern:       `Redirect::to\s*\(`,
			ObjectType:    "actix_web",
			MethodName:    "Redirect::to",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "HTTP redirect with potentially tainted URL",
			CWEID:         "CWE-601",
			OWASPCategory: "A01:2021-Broken Access Control",
		},

		// --- Deserialization (CWE-502) ---
		{
			ID:            "rust.bincode.deserialize",
			Category:      taint.SnkDeserialize,
			Language:      rules.LangRust,
			Pattern:       `bincode::deserialize\s*\(`,
			ObjectType:    "bincode",
			MethodName:    "bincode::deserialize",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "Binary deserialization of potentially untrusted data",
			CWEID:         "CWE-502",
			OWASPCategory: "A08:2021-Software and Data Integrity Failures",
		},

		// --- Log Injection (CWE-117) ---
		{
			ID:            "rust.log.info",
			Category:      taint.SnkLog,
			Language:      rules.LangRust,
			Pattern:       `(?:log::)?info!\s*\(`,
			ObjectType:    "log",
			MethodName:    "info!",
			DangerousArgs: []int{-1},
			Severity:      rules.Medium,
			Description:   "Log macro with potentially tainted data",
			CWEID:         "CWE-117",
			OWASPCategory: "A09:2021-Security Logging and Monitoring Failures",
		},
		{
			ID:            "rust.tracing.info",
			Category:      taint.SnkLog,
			Language:      rules.LangRust,
			Pattern:       `tracing::info!\s*\(`,
			ObjectType:    "tracing",
			MethodName:    "tracing::info!",
			DangerousArgs: []int{-1},
			Severity:      rules.Medium,
			Description:   "Tracing macro with potentially tainted data",
			CWEID:         "CWE-117",
			OWASPCategory: "A09:2021-Security Logging and Monitoring Failures",
		},
	}
}
