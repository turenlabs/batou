package languages

import (
	"github.com/turenio/gtss/internal/rules"
	"github.com/turenio/gtss/internal/taint"
)

func (c *LuaCatalog) Sinks() []taint.SinkDef {
	return []taint.SinkDef{
		// --- Command Injection (CWE-78) ---
		{
			ID:            "lua.os.execute",
			Category:      taint.SnkCommand,
			Language:      rules.LangLua,
			Pattern:       `os\.execute\s*\(`,
			ObjectType:    "",
			MethodName:    "os.execute",
			DangerousArgs: []int{0},
			Severity:      rules.Critical,
			Description:   "OS command execution with potentially tainted input",
			CWEID:         "CWE-78",
			OWASPCategory: "A03:2021-Injection",
		},
		{
			ID:            "lua.io.popen",
			Category:      taint.SnkCommand,
			Language:      rules.LangLua,
			Pattern:       `io\.popen\s*\(`,
			ObjectType:    "",
			MethodName:    "io.popen",
			DangerousArgs: []int{0},
			Severity:      rules.Critical,
			Description:   "Process pipe with potentially tainted command",
			CWEID:         "CWE-78",
			OWASPCategory: "A03:2021-Injection",
		},

		// --- Code Injection (CWE-94) ---
		{
			ID:            "lua.loadstring",
			Category:      taint.SnkEval,
			Language:      rules.LangLua,
			Pattern:       `loadstring\s*\(`,
			ObjectType:    "",
			MethodName:    "loadstring",
			DangerousArgs: []int{0},
			Severity:      rules.Critical,
			Description:   "Dynamic code loading from string with potentially tainted input",
			CWEID:         "CWE-94",
			OWASPCategory: "A03:2021-Injection",
		},
		{
			ID:            "lua.load",
			Category:      taint.SnkEval,
			Language:      rules.LangLua,
			Pattern:       `\bload\s*\(`,
			ObjectType:    "",
			MethodName:    "load",
			DangerousArgs: []int{0},
			Severity:      rules.Critical,
			Description:   "Dynamic code loading with potentially tainted input",
			CWEID:         "CWE-94",
			OWASPCategory: "A03:2021-Injection",
		},
		{
			ID:            "lua.dofile",
			Category:      taint.SnkEval,
			Language:      rules.LangLua,
			Pattern:       `dofile\s*\(`,
			ObjectType:    "",
			MethodName:    "dofile",
			DangerousArgs: []int{0},
			Severity:      rules.Critical,
			Description:   "Execute Lua file with potentially tainted path",
			CWEID:         "CWE-94",
			OWASPCategory: "A03:2021-Injection",
		},
		{
			ID:            "lua.loadfile",
			Category:      taint.SnkEval,
			Language:      rules.LangLua,
			Pattern:       `loadfile\s*\(`,
			ObjectType:    "",
			MethodName:    "loadfile",
			DangerousArgs: []int{0},
			Severity:      rules.Critical,
			Description:   "Load Lua file with potentially tainted path",
			CWEID:         "CWE-94",
			OWASPCategory: "A03:2021-Injection",
		},

		// --- SQL Injection (CWE-89) ---
		{
			ID:            "lua.resty.mysql.query",
			Category:      taint.SnkSQLQuery,
			Language:      rules.LangLua,
			Pattern:       `:query\s*\(`,
			ObjectType:    "resty.mysql",
			MethodName:    "db:query",
			DangerousArgs: []int{0},
			Severity:      rules.Critical,
			Description:   "MySQL query via lua-resty-mysql with potentially tainted input",
			CWEID:         "CWE-89",
			OWASPCategory: "A03:2021-Injection",
		},
		{
			ID:            "lua.ngx.postgres.query",
			Category:      taint.SnkSQLQuery,
			Language:      rules.LangLua,
			Pattern:       `ngx\.location\.capture.*ngx_postgres`,
			ObjectType:    "ngx_postgres",
			MethodName:    "ngx_postgres query",
			DangerousArgs: []int{0},
			Severity:      rules.Critical,
			Description:   "PostgreSQL query via ngx_postgres with potentially tainted input",
			CWEID:         "CWE-89",
			OWASPCategory: "A03:2021-Injection",
		},

		// --- Path Traversal / File Operations (CWE-22) ---
		{
			ID:            "lua.io.open",
			Category:      taint.SnkFileWrite,
			Language:      rules.LangLua,
			Pattern:       `io\.open\s*\(`,
			ObjectType:    "",
			MethodName:    "io.open",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "File open with potentially tainted path",
			CWEID:         "CWE-22",
			OWASPCategory: "A01:2021-Broken Access Control",
		},
		{
			ID:            "lua.os.remove",
			Category:      taint.SnkFileWrite,
			Language:      rules.LangLua,
			Pattern:       `os\.remove\s*\(`,
			ObjectType:    "",
			MethodName:    "os.remove",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "File removal with potentially tainted path",
			CWEID:         "CWE-22",
			OWASPCategory: "A01:2021-Broken Access Control",
		},
		{
			ID:            "lua.os.rename",
			Category:      taint.SnkFileWrite,
			Language:      rules.LangLua,
			Pattern:       `os\.rename\s*\(`,
			ObjectType:    "",
			MethodName:    "os.rename",
			DangerousArgs: []int{0, 1},
			Severity:      rules.High,
			Description:   "File rename with potentially tainted paths",
			CWEID:         "CWE-22",
			OWASPCategory: "A01:2021-Broken Access Control",
		},

		// --- XSS / HTML Output (CWE-79) ---
		{
			ID:            "lua.ngx.say",
			Category:      taint.SnkHTMLOutput,
			Language:      rules.LangLua,
			Pattern:       `ngx\.say\s*\(`,
			ObjectType:    "ngx",
			MethodName:    "ngx.say",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "OpenResty response output with potentially tainted data (XSS)",
			CWEID:         "CWE-79",
			OWASPCategory: "A03:2021-Injection",
		},
		{
			ID:            "lua.ngx.print",
			Category:      taint.SnkHTMLOutput,
			Language:      rules.LangLua,
			Pattern:       `ngx\.print\s*\(`,
			ObjectType:    "ngx",
			MethodName:    "ngx.print",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "OpenResty response output with potentially tainted data (XSS)",
			CWEID:         "CWE-79",
			OWASPCategory: "A03:2021-Injection",
		},

		// --- Open Redirect (CWE-601) ---
		{
			ID:            "lua.ngx.redirect",
			Category:      taint.SnkRedirect,
			Language:      rules.LangLua,
			Pattern:       `ngx\.redirect\s*\(`,
			ObjectType:    "ngx",
			MethodName:    "ngx.redirect",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "OpenResty redirect with potentially tainted URL",
			CWEID:         "CWE-601",
			OWASPCategory: "A01:2021-Broken Access Control",
		},
		{
			ID:            "lua.ngx.exec",
			Category:      taint.SnkRedirect,
			Language:      rules.LangLua,
			Pattern:       `ngx\.exec\s*\(`,
			ObjectType:    "ngx",
			MethodName:    "ngx.exec",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "OpenResty internal redirect with potentially tainted URI",
			CWEID:         "CWE-601",
			OWASPCategory: "A01:2021-Broken Access Control",
		},

		// --- Redis command with tainted data ---
		{
			ID:            "lua.redis.call",
			Category:      taint.SnkCommand,
			Language:      rules.LangLua,
			Pattern:       `redis\.call\s*\(`,
			ObjectType:    "redis",
			MethodName:    "redis.call",
			DangerousArgs: []int{-1},
			Severity:      rules.High,
			Description:   "Redis command execution with potentially tainted arguments",
			CWEID:         "CWE-77",
			OWASPCategory: "A03:2021-Injection",
		},

		// --- Deserialization (CWE-502) ---
		{
			ID:            "lua.loadstring.deser",
			Category:      taint.SnkDeserialize,
			Language:      rules.LangLua,
			Pattern:       `loadstring\s*\(.*:receive|loadstring\s*\(.*socket`,
			ObjectType:    "",
			MethodName:    "loadstring (deserialization)",
			DangerousArgs: []int{0},
			Severity:      rules.Critical,
			Description:   "loadstring used to deserialize network data (code injection via deserialization)",
			CWEID:         "CWE-502",
			OWASPCategory: "A08:2021-Software and Data Integrity Failures",
		},

		// --- Log Injection (CWE-117) ---
		{
			ID:            "lua.ngx.log",
			Category:      taint.SnkLog,
			Language:      rules.LangLua,
			Pattern:       `ngx\.log\s*\(`,
			ObjectType:    "ngx",
			MethodName:    "ngx.log",
			DangerousArgs: []int{1},
			Severity:      rules.Medium,
			Description:   "OpenResty log with potentially tainted data",
			CWEID:         "CWE-117",
			OWASPCategory: "A09:2021-Security Logging and Monitoring Failures",
		},

		// --- Template Injection (CWE-1336) ---
		{
			ID:            "lua.resty.template.render",
			Category:      taint.SnkTemplate,
			Language:      rules.LangLua,
			Pattern:       `template\.render\s*\(|template\.new\s*\(.*\)\s*:render\s*\(`,
			ObjectType:    "resty.template",
			MethodName:    "template.render",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "lua-resty-template rendering with potentially tainted context",
			CWEID:         "CWE-1336",
			OWASPCategory: "A03:2021-Injection",
		},
		{
			ID:            "lua.lapis.render",
			Category:      taint.SnkTemplate,
			Language:      rules.LangLua,
			Pattern:       `self:render\s*\(|render_html\s*\(`,
			ObjectType:    "lapis",
			MethodName:    "self:render",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "Lapis template rendering with potentially tainted data",
			CWEID:         "CWE-1336",
			OWASPCategory: "A03:2021-Injection",
		},

		// --- SSRF / URL Fetch (CWE-918) ---
		{
			ID:            "lua.resty.http.request",
			Category:      taint.SnkURLFetch,
			Language:      rules.LangLua,
			Pattern:       `httpc:request_uri\s*\(|httpc:request\s*\(`,
			ObjectType:    "resty.http",
			MethodName:    "httpc:request_uri",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "OpenResty HTTP client with potentially tainted URL (SSRF)",
			CWEID:         "CWE-918",
			OWASPCategory: "A10:2021-Server-Side Request Forgery",
		},
		{
			ID:            "lua.socket.http.request",
			Category:      taint.SnkURLFetch,
			Language:      rules.LangLua,
			Pattern:       `http\.request\s*\(|socket\.http\.request\s*\(`,
			ObjectType:    "socket.http",
			MethodName:    "http.request",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "LuaSocket HTTP request with potentially tainted URL (SSRF)",
			CWEID:         "CWE-918",
			OWASPCategory: "A10:2021-Server-Side Request Forgery",
		},
		{
			ID:            "lua.ngx.location.capture",
			Category:      taint.SnkURLFetch,
			Language:      rules.LangLua,
			Pattern:       `ngx\.location\.capture\s*\(`,
			ObjectType:    "ngx",
			MethodName:    "ngx.location.capture",
			DangerousArgs: []int{0},
			Severity:      rules.High,
			Description:   "OpenResty subrequest with potentially tainted URI",
			CWEID:         "CWE-918",
			OWASPCategory: "A10:2021-Server-Side Request Forgery",
		},

		// --- HTTP Header Injection (CWE-113) ---
		{
			ID:            "lua.ngx.header",
			Category:      taint.SnkHeader,
			Language:      rules.LangLua,
			Pattern:       `ngx\.header\.\w+\s*=|ngx\.header\[`,
			ObjectType:    "ngx",
			MethodName:    "ngx.header",
			DangerousArgs: []int{0},
			Severity:      rules.Medium,
			Description:   "OpenResty response header with potentially tainted value",
			CWEID:         "CWE-113",
			OWASPCategory: "A03:2021-Injection",
		},

		// --- Weak Crypto ---
		{
			ID:            "lua.ngx.md5",
			Category:      taint.SnkCrypto,
			Language:      rules.LangLua,
			Pattern:       `ngx\.md5\s*\(|ngx\.md5_bin\s*\(`,
			ObjectType:    "ngx",
			MethodName:    "ngx.md5",
			DangerousArgs: []int{0},
			Severity:      rules.Medium,
			Description:   "Weak MD5 hash usage via OpenResty",
			CWEID:         "CWE-328",
			OWASPCategory: "A02:2021-Cryptographic Failures",
		},

		// --- Additional log sinks ---
		{
			ID:            "lua.print.log",
			Category:      taint.SnkLog,
			Language:      rules.LangLua,
			Pattern:       `print\s*\(`,
			ObjectType:    "",
			MethodName:    "print",
			DangerousArgs: []int{0},
			Severity:      rules.Low,
			Description:   "Print output with potentially tainted data",
			CWEID:         "CWE-117",
			OWASPCategory: "A09:2021-Security Logging and Monitoring Failures",
		},

		// --- File operations (CWE-22) ---
		{
			ID:            "lua.os.rename",
			Category:      taint.SnkFileWrite,
			Language:      rules.LangLua,
			Pattern:       `os\.rename\s*\(`,
			ObjectType:    "",
			MethodName:    "os.rename",
			DangerousArgs: []int{0, 1},
			Severity:      rules.High,
			Description:   "File rename with potentially tainted paths",
			CWEID:         "CWE-22",
			OWASPCategory: "A01:2021-Broken Access Control",
		},

		// --- Dynamic code loading (CWE-94) ---
		{
			ID:            "lua.loadstring",
			Category:      taint.SnkEval,
			Language:      rules.LangLua,
			Pattern:       `loadstring\s*\(|load\s*\(`,
			ObjectType:    "",
			MethodName:    "loadstring/load",
			DangerousArgs: []int{0},
			Severity:      rules.Critical,
			Description:   "Dynamic Lua code loading with potentially tainted string",
			CWEID:         "CWE-94",
			OWASPCategory: "A03:2021-Injection",
		},

		// --- Redis eval (CWE-94) ---
		{
			ID:            "lua.redis.eval",
			Category:      taint.SnkEval,
			Language:      rules.LangLua,
			Pattern:       `redis\.call\s*\(\s*['"]EVAL`,
			ObjectType:    "redis",
			MethodName:    "call(EVAL)",
			DangerousArgs: []int{1},
			Severity:      rules.Critical,
			Description:   "Redis EVAL with potentially tainted Lua script",
			CWEID:         "CWE-94",
			OWASPCategory: "A03:2021-Injection",
		},

		// --- Symlink (CWE-59) ---
		{
			ID:            "lua.lfs.link",
			Category:      taint.SnkFileWrite,
			Language:      rules.LangLua,
			Pattern:       `lfs\.link\s*\(`,
			ObjectType:    "lfs",
			MethodName:    "link",
			DangerousArgs: []int{0, 1},
			Severity:      rules.High,
			Description:   "LuaFileSystem link/symlink creation with potentially tainted paths",
			CWEID:         "CWE-59",
			OWASPCategory: "A01:2021-Broken Access Control",
		},
	}
}
